<xsql-script name='es_sii_mr_lrfe'>
<!-- ======================================================================= -->
<!--                                                                         -->
<!-- XSQL es_sii_mr_lrfe                                                     -->
<!--                                                                         -->
<!-- Proceso para la generación del mensaje de solicitud de una factura      -->
<!-- emitida para el sistema SII.                                            -->
<!--                                                                         -->
<!--     SuministroLRFacturasEmitidas:     Altas y Modificaciones            -->
<!--     BajaLRFacturasEmitidas:           Bajas / Anulación                 -->
<!--                                                                         -->
<!-- No incluye Envelope, Body ni Cabecera                                   -->
<!--                                                                         -->
<!-- Se invoca desde al proceso principal de generación de mensajes:         -->
<!--                                                                         -->
<!-- Package: "es_sii_mr"     mr = Make Requests                             -->
<!--                                                                         -->
<!-- ======================================================================= -->

        <args>
            <arg name='p_empcode'               type='string' />
            <arg name='p_nifpresentador'        type='string' />
            <arg name='p_head_seqno'            type='integer' />
            <arg name='p_idemisor'              type='string' />
            <arg name='p_numfactura'            type='string' />
            <arg name='p_fechafactura'          type='date' />
            <arg name='p_ejercicio'             type='string' />
            <arg name='p_periodo'               type='string' />
            <arg name='p_tipofactura'           type='string' />
            <arg name='p_claveoperacion'        type='string' />
            <arg name='p_claveoperaciona1'      type='string' />
            <arg name='p_claveoperaciona2'      type='string' />
            <arg name='p_importetotal'          type='decimal' />
            <arg name='p_descoperacion'         type='string' />
            <arg name='p_idversionsii'          type='string' />
            <arg name='p_tipocomunicacion'      type='string' />    <!-- A0  Alta de facturas/registro                                -->
                                                                    <!-- A1  Modificación de facturas/registros (errores registrales) -->
                                                                    <!-- A4  Modificación Factura Régimen de Viajeros                 -->
                                                                    <!-- B   Baja. ( Adaptación Axional )                             -->
        </args>

    <body>


        <!-- ======================================================================= -->
        <!-- FUNC local_get_nif_or_idotro                                            -->
        <!--                                                                         -->
        <!-- Devuelve tags nif y idotro                                              -->
        <!--                                                                         -->
        <!-- ======================================================================= -->
        <function name='local_get_nif_or_idotro'>
            <args>
                <arg name='p_nif'       type='string' />
				<arg name='p_orden'     type='integer' />
            </args>
            <body>

                <!-- ======================================================================= -->
                <!-- El contenido de p_nif debe ser autosuficiente para determinar           -->
                <!-- el país y a partir del país determinar si es intracomunitario o no.     -->
                <!-- El motivo es que para comunicar las bajas de facturas no disponemos de  -->
                <!-- soporte en cimpcont_head y por lo tanto tampoco de cimpcont que es      -->
                <!-- donde se ubica el código de país.                                       -->
                <!-- ======================================================================= -->
                <set name='m_nif_spain'><p_nif/></set>
                <set name='m_len'><string.length><p_nif/></string.length></set>
				<!-- CURSACH: Asteriscado porque CIF 0 con coda2 da error
                <if>
                    <expr>
                        <le><m_len/>2</le>
                    </expr>
                    <then>
                        <set name='m_str_nif'><xml.sii:NIF><p_nif/></xml.sii:NIF></set>
                        <set name='m_str_idotro'><string/></set>
                        <return>
                            <m_nif_spain/>
                            <m_str_nif/>
                            <m_str_idotro/>
                        </return>
                    </then>
                </if>
				-->
				
                <!-- ======================================================================= -->
                <!-- Obtiene NIF, País, idtype, etc.                                         -->
                <!-- IDType                                                                  -->
                <!-- L4 Tipos de Identificación en el país de residencia  (Pag 71)           -->
                <!--    02 NIF-IVA                                                           -->
                <!--    03 PASAPORTE                                                         -->
                <!--    04 DOCUMENTO OFICIAL DE IDENTIFICACIÓN EXPEDIDO POR EL PAIS O TERRITORIO DE RESIDENCIA -->
                <!--    05 CERTIFICADO DE RESIDENCIA                                         -->
                <!--    06 OTRO DOCUMENTO PROBATORIO                                         -->
                <!-- ======================================================================= -->
				<!-- CURSACH: Asteriscado para permitir CIF 0
                <set name='m_coda2'><string.substring><p_nif/><number>0</number><number>2</number></string.substring></set>
				-->
				<!--
                <if>
                    <expr>
                        <string.regexp><m_coda2/><string>[A-Z]{2,2}</string></string.regexp>
                    </expr>
                    <then>
				-->	
                        <select prefix='m_'>
                            <columns>
                                --ctiponac.coda2,
								NVL(ctiponac.coda2, cimpcont.codnac) coda2,
                                CASE WHEN NVL(ctiponac.coda2, cimpcont.codnac) = 'ES'
                                          THEN CASE WHEN <substr><p_nif/>,1,2</substr> = 'ES'
                                                    THEN <substr><p_nif/>,3,11</substr>
                                                    ELSE <substr><p_nif/>,1,9</substr>
                                                END
                                          ELSE NULL
                                 END AS nif_spain,
                                CASE WHEN ctiponac.coda2  = 'ES'                        THEN NULL
                                     WHEN ctiponac.coda2 != 'ES' AND ctiponac.indue = 1 AND <p_nif/> != '0' THEN '02'
                                     WHEN ctiponac.coda2 != 'ES' AND ctiponac.indue = 1 AND <p_nif/> = '0' THEN '06'									 
                                     WHEN ctiponac.coda2 != 'ES' AND ctiponac.indue = 0 THEN '04'
                                     ELSE '06'
                                 END AS idtype,
                                CASE WHEN ctiponac.indue = 1 THEN <p_nif/>      <!-- No suprime el código de país (coda2) de intracomunitarios ! -->
                                          ELSE CASE WHEN ctiponac.coda2 = <substr><p_nif/>,1,2</substr>
                                                    THEN <substr><p_nif/>,3</substr>
                                                    ELSE <p_nif/>
                                                END
                                 END AS nif_otro
                            </columns>
                            <!--<from table='ctiponac'/>-->
							<from table='cimpcont'>
								<join type='left' table='ctiponac'>
									<on>cimpcont.codnac = ctiponac.codigo</on>
								</join>
							</from>
							
                            <where>
									cimpcont.orden    = <p_orden/>
                                    <!--ctiponac.coda2 = <m_coda2/>-->
                            </where>
                        </select>			

                        <if>
                            <expr>
                                <or>
									<isnull><m_coda2/></isnull>
									<eq><string.length><m_coda2/></string.length>0</eq>
								</or>	
                            </expr>
                            <then>
                                <set name='m_coda2'>GB</set>
                            </then>
                        </if>

						
						<!-- ================================================================= -->
						<!-- Cursach: Si el CIF es extranjero y no coincide con el indicativo  -->
						<!-- país, ponemos idtype = '06'                                       -->
						<!-- ================================================================= -->
						<if>
							<expr>
								<ge><m_len/>2</ge>
							</expr>
							<then>
												
								<if>
									<expr>
										<and>
											<ne><m_coda2/><string.substring><p_nif/><number>0</number><number>2</number></string.substring></ne>
											<eq><m_idtype/><string>02</string></eq>
										</and>	
									</expr>
									<then>
										<set name='m_idtype'><string>06</string></set>
									</then>
								</if>
								
							</then>
						</if>	
						
						
                        <if>
                            <expr>
                                <isnull><m_nif_otro/></isnull>
                            </expr>
                            <then>
                                <set name='m_nif_spain'><p_nif/></set>
                            </then>
                        </if>
				<!--		
                    </then>
                </if>
				-->
                <!-- ======================================================================= -->
                <!-- NIF                                                                     -->
                <!-- ======================================================================= -->

                <if>
                    <expr>
                        <isnotnull><m_nif_spain/></isnotnull>
                    </expr>
                    <then>
                        <!-- ======================================================================= -->
                        <!-- NIF español                                                             -->
                        <!-- ======================================================================= -->
                        <set name='m_str_nif'><xml.sii:NIF><m_nif_spain/></xml.sii:NIF></set>
                        <set name='m_str_idotro'><string/></set>
                    </then>
                    <else>
                        <!-- ======================================================================= -->
                        <!-- NIF extranjero                                                          -->
                        <!-- ======================================================================= -->
                        <set name='m_str_nif'><string/></set>
                        <set name='m_str_idotro'>
                            <xml.sii:IDOtro>
                                <xml.sii:CodigoPais><m_coda2/></xml.sii:CodigoPais>
                                <xml.sii:IDType><m_idtype/></xml.sii:IDType>
                                <xml.sii:ID><m_nif_otro/></xml.sii:ID>
                            </xml.sii:IDOtro>
                        </set>
                    </else>
                </if>

                <!-- ======================================================================= -->
                <!--                                                                         -->
                <!-- ======================================================================= -->
                <return>
                    <m_nif_spain/>
                    <m_str_nif/>
                    <m_str_idotro/>
                </return>

            </body>
        </function>


        <!-- ======================================================================= -->
        <!-- FUNC local_get_datosinmueble                                            -->
        <!-- ======================================================================= -->
        <function name='local_get_datosinmueble'>
            <args>
                <arg name='p_empcode'               type='string' />
                <arg name='p_inm_situacion'         type='smallint' />
                <arg name='p_inm_refer_catastral'   type='string' />
            </args>
            <body>

                <!-- ======================================================================= -->
                <!--                                                                         -->
                <!-- ======================================================================= -->
                <set name='str_datosinmueble'><string/></set>
                <set name='str_detalleinmueble_all'><string/></set>

                <!--
                DatosInmueble
                   DetalleInmueble
                       SituacionInmueble
                       ReferenciaCatastral
                -->

                <!-- ======================================================================= -->
                <!-- Primero busca la lista de las referencias catastrales en es_sii_inm_refcat -->
                <!-- ======================================================================= -->
                <foreach>
                    <select prefix='es_sii_inm_refcat_'>
                        <columns>
                            es_sii_inm_refcat.*
                        </columns>
                        <from table='es_sii_inm_refcat' />
                        <where>
                                empcode = <p_empcode/>
                            AND grupo   = <p_inm_refer_catastral/>
                        </where>
                        <order>empcode, grupo, refer_catastral</order>
                    </select>
                    <do>
                        <set name='str_detalleinmueble_all'>
                            <string>
                                <str_detalleinmueble_all/>
                                <xml.sii:DetalleInmueble>
                                    <xml.sii:SituacionInmueble><es_sii_inm_refcat_situacion/></xml.sii:SituacionInmueble>
                                    <xml.sii:ReferenciaCatastral><es_sii_inm_refcat_refer_catastral/></xml.sii:ReferenciaCatastral>
                                </xml.sii:DetalleInmueble>
                            </string>
                        </set>
                    </do>
                </foreach>

                <!-- ======================================================================= -->
                <!-- Si solo hay una referencia obtiene los datos directamwente.             -->
                <!-- ======================================================================= -->
                <if>
                    <expr>
                        <eq><string.length><str_detalleinmueble_all/></string.length>0</eq>
                    </expr>
                    <then>
                        <!-- Situación inmueble -->
                        <set name='str_situacioninmueble'><string/></set>
                        <if>
                            <expr>
                                <isnotnull><p_inm_situacion/></isnotnull>
                            </expr>
                            <then>
                                <set name='str_situacioninmueble'><xml.sii:SituacionInmueble><p_inm_situacion/></xml.sii:SituacionInmueble></set>
                            </then>
                        </if>

                        <!-- Referencia catastral -->
                        <set name='str_referenciacatastral'><string/></set>
                        <if>
                            <expr>
                                <isnotnull><p_inm_refer_catastral/></isnotnull>
                            </expr>
                            <then>
                                <set name='str_referenciacatastral'><xml.sii:ReferenciaCatastral><p_inm_refer_catastral/></xml.sii:ReferenciaCatastral></set>
                            </then>
                        </if>

                        <!-- ======================================================================= -->
                        <!--                                                                         -->
                        <!-- ======================================================================= -->
                        <if>
                            <expr>
                                <or>
                                    <gt><string.length><str_situacioninmueble/></string.length>0</gt>
                                    <gt><string.length><str_referenciacatastral/></string.length>0</gt>
                                </or>
                            </expr>
                            <then>
                                <set name='str_detalleinmueble_all'>
                                    <xml.sii:DetalleInmueble>
                                        <str_situacioninmueble/>
                                        <str_referenciacatastral/>
                                    </xml.sii:DetalleInmueble>
                                </set>
                            </then>
                        </if>

                    </then>
                </if>

                <!-- ======================================================================= -->
                <!--                                                                         -->
                <!-- ======================================================================= -->
                <if>
                    <expr>
                        <gt><string.length><str_detalleinmueble_all/></string.length>0</gt>
                    </expr>
                    <then>
                        <set name='str_datosinmueble'>
                            <string>
                                <xml.sii:DatosInmueble>
                                    <str_detalleinmueble_all/>
                                </xml.sii:DatosInmueble>
                            </string>
                        </set>
                    </then>
                </if>

                <!-- ======================================================================= -->
                <!--                                                                         -->
                <!-- ======================================================================= -->
                <return>
                    <str_datosinmueble/>
                </return>

            </body>
        </function>


        <!-- ======================================================================= -->
        <!-- MAIN PROCESS                                                            -->
        <!-- ======================================================================= -->
        <set name='m_natfac'>V</set>
        <set name='m_msg_id_factura'><string>Factura emitida. <string.nl/>Empresa: [<p_empcode/>] <string.nl/>Presentador: [<p_nifpresentador/>] <string.nl/>Id Emisor: [<p_idemisor/>] <string.nl/>Número de factura: [<p_numfactura/>] <string.nl/>Fecha de factura: [<p_fechafactura/>] <string.nl/>Tipo de comunicación: [<p_tipocomunicacion/>] <string.nl/>Id registro: [<ifnull><p_head_seqno/><string/></ifnull>]</string></set>

        <!-- ======================================================================= -->
        <!-- Determina si cimpcont TABLE o cimpcont_v VIEW                           -->
        <!-- ======================================================================= -->
        <set name='m_cimpcont_access'><local_get_tableorview>cimpcont</local_get_tableorview></set>

        <!-- ======================================================================= -->
        <!-- Comprueba el tipo de comunicación                                       -->
        <!-- ======================================================================= -->
        <if>
            <expr>
                <not><string.regexp><p_tipocomunicacion/><string>(A0|A1|B)</string></string.regexp></not>
            </expr>
            <then>
                <exception><string>Comunicación [<p_tipocomunicacion/>] no soportada. <string.nl/><m_msg_id_factura/></string></exception>
            </then>
        </if>

        <!-- ======================================================================== -->
        <!-- Analiza si existe la columna cempresa.grpent                             -->
        <!-- ======================================================================== -->
        <set name='m_exists_col_grpent'><table.findColumnIndex table='cempresa' column='grpent' /></set>

        <!-- ======================================================================= -->
        <!-- sii:PeriodoImpositivo                                                   -->
        <!-- ======================================================================= -->
        <set name='str_periodoimpositivo'>
            <xml.sii:PeriodoImpositivo>
                <xml.sii:Ejercicio><p_ejercicio/></xml.sii:Ejercicio>
                <xml.sii:Periodo><p_periodo/></xml.sii:Periodo>
            </xml.sii:PeriodoImpositivo>
        </set>

<!--
<?xml version="1.0" encoding="UTF-8"?>
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
xmlns:siiLR="https://www2.agenciatributaria.gob.es/static_files/common/internet/dep/aplicaciones/es/aeat/ssii/fact/ws/SuministroLR.xsd"
xmlns:sii="https://www2.agenciatributaria.gob.es/static_files/common/internet/dep/aplicaciones/es/aeat/ssii/fact/ws/SuministroInformacion.xsd">
<soapenv:Header/>
<soapenv:Body>
<siiLR:BajaLRFacturasEmitidas>
<sii:Cabecera>
<sii:IDVersionSii>0.6</sii:IDVersionSii>
<sii:Titular>
<sii:NombreRazon>EMPRESAXXXX</sii:NombreRazon>
<sii:NIF>A84532501</sii:NIF>
</sii:Titular>
</sii:Cabecera>
<siiLR:RegistroLRBajaExpedidas>
<sii:PeriodoImpositivo>
<sii:Ejercicio>2016</sii:Ejercicio>
<sii:Periodo>10</sii:Periodo>
</sii:PeriodoImpositivo>
<siiLR:IDFactura>
<sii:IDEmisorFactura>
<sii:NIF>A84532501</sii:NIF>
</sii:IDEmisorFactura>
<sii:NumSerieFacturaEmisor>000000000000000000000000000001000000000000000000000000000001</sii:NumSerieFacturaEmisor>
<sii:FechaExpedicionFacturaEmisor>08-05-2015</sii:FechaExpedicionFacturaEmisor>
</siiLR:IDFactura>
</siiLR:RegistroLRBajaExpedidas>
</siiLR:BajaLRFacturasEmitidas>
</soapenv:Body>
</soapenv:Envelope>
-->

        <!-- ======================================================================= -->
        <!-- MENSAJE BAJA:                                                           -->
        <!-- Tipo de comunicación:                                                   -->
        <!--    Alta / Modificación: siiLR:RegistroLRFacturasEmitidas                -->
        <!--    Baja:                siiLR:RegistroLRBajaExpedidas                   -->
        <!-- ======================================================================= -->
        <if>
            <expr>
                <eq><p_tipocomunicacion/>B</eq>
            </expr>
            <then>
                <!-- ======================================================================= -->
                <!-- siiLR:IDFactura                                                         -->
                <!-- ======================================================================= -->
                <set name='str_idfactura_baja'>
                    <xml.siiLR:IDFactura>
                        <xml.sii:IDEmisorFactura>
                            <xml.sii:NIF><p_idemisor/></xml.sii:NIF>
                        </xml.sii:IDEmisorFactura>
                        <xml.sii:NumSerieFacturaEmisor><p_numfactura/></xml.sii:NumSerieFacturaEmisor>
                        <xml.sii:FechaExpedicionFacturaEmisor><date.format format='dd-MM-yyyy'><p_fechafactura/></date.format></xml.sii:FechaExpedicionFacturaEmisor>
                    </xml.siiLR:IDFactura>
                </set>

                <set name='m_message_one_invoice'>
                    <xml.siiLR:RegistroLRBajaExpedidas>
                        <str_periodoimpositivo/>
                        <str_idfactura_baja/>
                    </xml.siiLR:RegistroLRBajaExpedidas>
                </set>
                <return>
                    <m_message_one_invoice/>
                </return>
            </then>
        </if>

        <!-- ======================================================================= -->
        <!-- MENSAJE ALTA o MODIFICACIÓN:                                            -->
        <!-- Tipo de comunicación:                                                   -->
        <!--    Alta / Modificación: siiLR:RegistroLRFacturasEmitidas                -->
        <!--    Baja:                siiLR:RegistroLRBajaExpedidas                   -->
        <!-- ======================================================================= -->

        <!-- ======================================================================= -->
        <!-- siiLR:FacturaExpedida                                                   -->
        <!-- ======================================================================= -->

        <!-- ======================================================================= -->
        <!--                                                                         -->
        <!-- ======================================================================= -->
        <select prefix='cimpcont_head_aux_' required='Registro [${p_head_seqno}] no encontrado.'>
            <columns>
                cimpcont_head.cif,
                cimpcont_head.orden,
                cimpcont_head_aux.*
            </columns>
            <from table='cimpcont_head'>
                <join type='left' table='cimpcont_head_aux'>
                    <on>cimpcont_head.head_seqno = cimpcont_head_aux.head_seqno</on>
                </join>
            </from>
            <where>
                    cimpcont_head.head_seqno  = <p_head_seqno/>
                AND cimpcont_head.natfac      = <m_natfac/>
            </where>
        </select>
        <set name='cimpcont_head_cif'><cimpcont_head_aux_cif/></set>
        <set name='cimpcont_head_orden'><cimpcont_head_aux_orden/></set>
        <unset name='cimpcont_head_aux_cif'/>
        <unset name='cimpcont_head_aux_orden'/>

        <!-- ======================================================================= -->
        <!-- L3 FE  08  Operaciones sujetas al IPSI / IGIC                           -->
        <!-- ======================================================================= -->
        <set name='m_operacion_sujeta_al_ipsi_igic'><false/></set>
        <if>
            <expr>
                <or>
                    <!-- L3 FE  08  Operaciones sujetas al IPSI / IGIC                           -->
                    <eq><p_claveoperacion/><string>08</string></eq>
                    <eq><ifnull><p_claveoperaciona1/><string/></ifnull><string>08</string></eq>
                    <eq><ifnull><p_claveoperaciona2/><string/></ifnull><string>08</string></eq>
                </or>
            </expr>
            <then>
                <set name='m_operacion_sujeta_al_ipsi_igic'><true/></set>
            </then>
        </if>

        <!-- ======================================================================= -->
        <!-- sii:BaseImponibleACoste                                                 -->
        <!--     Para grupos de IVA                                                  -->
        <!--                                                                         -->
        <!-- ClaveRegimenEspecialOTrascendencia   (Emitidas y Recibidas)             -->
        <!--                                                                         -->
        <!-- L3 FE  06  Régimen especial grupo de entidades en IVA (Nivel Avanzado)  -->
        <!-- L3 FR  06  Régimen especial grupo de entidades en IVA (Nivel Avanzado)  -->
        <!--                                                                         -->
        <!-- Ejemplos de operaciones intragrupo:
        Código  Descripción                                                         Modelo 303   Descripción

        CAE     Compras nacionales de arrendamientos intragrupo                   2.20         IVA Deducible - Por cuotas soportadas en operaciones interiores corrientes
        CNE     Compras nacionales de bienes y servicios corrientes intragrupo    2.20         IVA Deducible - Por cuotas soportadas en operaciones interiores corrientes
        CNIE    Compras nacionales de bienes y servicios de inversión intragrupo  2.20         IVA Deducible - Por cuotas soportadas en operaciones interiores corrientes

        VAE     Ventas nacionales de arrendamientos intragrupo                    1.05         IVA Devengado - Régimen general
        VNE     Ventas nacionales de bienes y servicios corrientes intragrupo     1.05         IVA Devengado - Régimen general
        VNIE    Ventas nacionales de bienes y servicios de inversión intragrupo   1.05         IVA Devengado - Régimen general
        -->
        <!-- ======================================================================= -->
        <set name='m_baseimponibleacoste'>0</set>
        <set name='cempresa_grpent'><null/></set>
        <if>
            <expr>
                <eq><p_claveoperacion/><string>06</string></eq>
            </expr>
            <then>
                <!-- ======================================================================= -->
                <!-- Verifica que la empresa pertenezca a un grupo de entidades.             -->
                <!-- ======================================================================= -->
                <if>
                    <expr>
                        <gt><m_exists_col_grpent/>0</gt>
                    </expr>
                    <then>
                        <select prefix='cempresa_' required='Empresa [${p_empcode}] no encontrada.'>
                            <columns>grpent</columns>
                            <from table='cempresa'/>
                            <where>
                                empcode = <p_empcode/>
                            </where>
                        </select>
                    </then>
                </if>
                <if>
                    <expr>
                        <isnull><cempresa_grpent/></isnull>
                    </expr>
                    <then>
                        <exception><string>Operación [<p_claveoperacion/>] declarada en régimen especial grupo de entidades en IVA (Nivel Avanzado) pero la empresa no tiene informado el código de grupo de entidades (cempresa.grpent). <string.nl/><m_msg_id_factura/></string></exception>
                    </then>
                </if>
            </then>
        </if>

        <!-- ======================================================================= -->
        <!-- Obtiene NIF, País, idtype, etc.                                         -->
        <!-- IDType                                                                  -->
        <!-- L4 Tipos de Identificación en el país de residencia  (Pag 71)           -->
        <!--    02 NIF-IVA                                                           -->
        <!--    03 PASAPORTE                                                         -->
        <!--    04 DOCUMENTO OFICIAL DE IDENTIFICACIÓN EXPEDIDO POR EL PAIS O TERRITORIO DE RESIDENCIA -->
        <!--    05 CERTIFICADO DE RESIDENCIA                                         -->
        <!--    06 OTRO DOCUMENTO PROBATORIO                                         -->
        <!-- ======================================================================= -->
<!-- 12-06-2017 ( Igualat al emissor de rebudes ! )
fcm Contrastar amb l'emissor de fres rebudes !
        <select prefix='old_contraparte_' required='Registro [${cimpcont_head_orden}] no encontrado.'>
            <columns>
                ctiponac.coda2,

                 Tercero Español o Extranjero residente en España con NIE otorgado. 
                CASE WHEN ctiponac.coda2 = 'ES'
                          THEN CASE WHEN <substr>cimpcont.cif,1,2</substr> = 'ES'
                                    THEN <substr>cimpcont.cif,3,11</substr>
                                    ELSE <substr>cimpcont.cif,1,9</substr>
                                END
                          ELSE NULL
                 END AS nif_spain,
                CASE WHEN ctiponac.coda2  = 'ES'                        THEN '02'  02: NIF-IVA 
                     WHEN ctiponac.coda2 != 'ES' AND ctiponac.indue = 1 THEN '02'  !!! 04: DOCUMENTO OFICIAL DE IDENTIFICACIÓN EXPEDIDO POR EL PAIS O TERRITORIO DE RESIDENCIA. 
                     WHEN ctiponac.coda2 != 'ES' AND ctiponac.indue = 0 THEN '04'  04: DOCUMENTO OFICIAL DE IDENTIFICACIÓN EXPEDIDO POR EL PAIS O TERRITORIO DE RESIDENCIA. 
                     ELSE '06'                                                     06: OTRO DOCUMENTO PROBATORIO 

                 END AS idtype,
                CASE WHEN ctiponac.indue = 1 THEN cimpcont.cif       Suprime el código de país (coda2) de intracomunitarios ! 
                          ELSE CASE WHEN ctiponac.coda2 = <substr>cimpcont.cif,1,2</substr>
                                    THEN <substr>cimpcont.cif,3</substr>
                                    ELSE cimpcont.cif
                                END
                 END AS nif_contraparte
                 NIF contraparte sin código de país. 
               ,CASE WHEN ctiponac.coda2 = <substr>cimpcont.cif,1,2</substr>
                          THEN <substr>cimpcont.cif,3</substr>
                          ELSE cimpcont.cif
                 END AS nif_contraparte_old
            </columns>
            <from table='${m_cimpcont_access}' alias='cimpcont'>
                <join type='left' table='ctiponac'>
                    <on>cimpcont.codnac = ctiponac.codigo</on>
                </join>
            </from>
            <where>
                    cimpcont.empcode  = <p_empcode/>
                AND cimpcont.natfac   = <m_natfac/>
                AND cimpcont.docser   = <p_numfactura/>
                AND cimpcont.cif      = <cimpcont_head_cif/>
                AND cimpcont.fecdoc   = <p_fechafactura/>
                AND cimpcont.valida  != 'R'      Excluye registros: Cobros y/o pagos RECC o  Cobros y/o pagos de certificaciones de obras 

 fcm 08-05-2017
O quitamos tipimp = N o en el XUDP cimpcont_head_upgrade añadimos una exlusión para los registros
del recargo de equiuvalencia puesto que éstos en ocasiones también pueden ser los creadores del
regitro cabecera en cimpcont_head

                AND cimpcont.tipimp   = 'N'


                AND cimpcont.orden    = <cimpcont_head_orden/>
            </where>
        </select>


        <if>
            <expr>
                <isnull><old_contraparte_coda2/></isnull>
            </expr>
            <then>
                 Error no previsto. Existe F.K. a ctiponac i además coda2 es NOT NULL 
                <exception><string>País no identificado en documento. <string.nl/><m_msg_id_factura/></string></exception>
            </then>
        </if>
-->

        <!-- ======================================================================= -->
        <!-- En Compras NIF emisor y NIF contraparte contienen el mismo valor.       -->
        <!-- ======================================================================= -->
        <local_get_nif_or_idotro into='m_contraparte_nif_spain, m_contraparte_nif, m_contraparte_idotro'>
            <cimpcont_head_cif/>
			<cimpcont_head_orden/>
        </local_get_nif_or_idotro>

        <!-- ======================================================================= -->
        <!-- Customización.                                                          -->
        <!-- ======================================================================= -->

        <!-- ======================================================================= -->
        <!-- FacturasAgrupadas                                                       -->
        <!-- NO SOPORTADO: Informar mediante customización.                          -->
        <!-- ======================================================================= -->
        <set name='str_facturasagrupadas'><string/></set>
        <set name='m_default_inm_situacion'><null/></set>
        <set name='m_default_inm_refer_catastral'><null/></set>
        <set name='str_datosinmueble'><string/></set>
        <set name='m_excluir_suplidos'><false/></set>       <!-- Cambiar a true para no informar suplidos al sistema SII , excluir en coperimp.nomope *(SUP)*  O  *[SUP]*-->
        <include code='es_sii_mr_lrfe' name='before' />

        <!-- ======================================================================= -->
        <!-- Comprueba desglose facturas agrupadas si el tipo de factura es F3:      -->
        <!--     F3 Factura emitida en sustitución de facturas simplificadas facturadas y declaradas -->
        <!-- ======================================================================= -->
        <if>
            <expr>
                <eq><p_tipofactura/><string>F3</string></eq>
            </expr>
            <then>
                <if>
                    <expr>
                        <isnull><str_facturasagrupadas/></isnull>
                    </expr>
                    <then>
                        <exception><string>Está declarando una factura emitida en sustitución de facturas simplificadas facturadas y declaradas. Tipo de factura [<p_tipofactura/>] . <string.nl/>Debe informar desglose de facturas agrupadas (FacturasAgrupadas). <string.nl/><m_msg_id_factura/></string></exception>
                   </then>
                </if>
           </then>
        </if>

        <!-- ======================================================================= -->
        <!-- Especificación del tipo de factura a dar de alta  { L2 TipoFactura }    -->
        <!--                                                                         -->
        <!-- Etiqueta: TipoFactura                                                   -->
        <!--                                                                         -->
        <!-- SII    17-05-2017    Versión 0.7                                        -->
        <!--                                                                         -->
        <!-- Tipos de facturas emitidas                                              -->
        <!-- ==========================                                              -->
        <!-- L2 FE  F1  Factura                                                      -->
        <!-- L2 FE  F2  Simplificada (ticket)                                        -->
        <!-- L2 FE  F3  Sustitución de facturas simplificadas declaradas             -->
        <!-- L2 FE  F4  Asiento resumen de facturas                                  -->
        <!-- L2 FE  R1  Rectificativa (Error fundado y Art. 80 Uno Dos y Seis LIVA)  -->
        <!-- L2 FE  R2  Rectificativa (Art 80.3)                                     -->
        <!-- L2 FE  R3  Rectificativa (Art 80.4)                                     -->
        <!-- L2 FE  R4  Rectificativa (Resto)                                        -->
        <!-- L2 FE  R5  Rectificativa en facturas simplificadas                      -->
        <!--                                                                         -->
        <!-- Tipos de facturas recibidas                                             -->
        <!-- ===========================                                             -->
        <!-- L2 FR  F1  Factura                                                      -->
        <!-- L2 FR  F2  Simplificada (ticket)                                        -->
        <!-- L2 FR  F3  Sustitución de facturas simplificadas declaradas (opcional)  -->
        <!-- L2 FR  F4  Asiento resumen de facturas                                  -->
        <!-- L2 FR  F5  Importaciones (DUA)                                          -->
        <!-- L2 FR  F6  Justificantes contables                                      -->
        <!-- L2 FR  R1  Rectificativa (Error fundado y Art.80.1,2,6 LIVA) (opcional) -->
        <!-- L2 FR  R2  Rectificativa (Art 80.3) (opcional)                          -->
        <!-- L2 FR  R3  Rectificativa (Art 80.4) (opcional)                          -->
        <!-- L2 FR  R4  Rectificativa (Resto) (opcional)                             -->
        <!-- L2 FR  R5  Rectificativa simplificada (opcional)                        -->
        <!--                                                                         -->
        <!-- ======================================================================= -->

        <!-- ======================================================================= -->
        <!-- L2 FE  F4  Asiento resumen de facturas                                  -->
        <!--                                                                         -->
        <!-- Con tipo de factura F4 se declaran los resúmenes de facturación de los  -->
        <!-- cierres de TPV de las empresas de retail.                               -->
        <!-- Comprueba el último número de factura en Asiento resumen de facturas.   -->
        <!-- ======================================================================= -->
        <set name='str_numseriefacturaemisorresumenfin'><string/></set>
        <if>
            <expr>
                <eq><p_tipofactura/><string>F4</string></eq>
            </expr>
            <then>
                <if>
                    <expr>
                        <isnull><cimpcont_head_aux_last_numfactura/></isnull>
                    </expr>
                    <then>
                        <exception><string>Está declarando un Asiento resumen de facturas [<p_tipofactura/>]. <string.nl/>Debe informar el último número de factura. <string.nl/><m_msg_id_factura/></string></exception>
                   </then>
                </if>
                <if>
                    <expr>
                        <eq><p_numfactura/><cimpcont_head_aux_last_numfactura/></eq>
                    </expr>
                    <then>
                        <exception><string>Está declarando un Asiento resumen de facturas [<p_tipofactura/>]. <string.nl/>El primer y último número de factura no pueden ser iguales. <string.nl/><m_msg_id_factura/></string></exception>
                   </then>
                </if>

                <!-- NumSerieFacturaEmisorResumenFin -->
                <set name='str_numseriefacturaemisorresumenfin'><xml.sii:NumSerieFacturaEmisorResumenFin><cimpcont_head_aux_last_numfactura/></xml.sii:NumSerieFacturaEmisorResumenFin></set>
           </then>
        </if>

        <!-- ======================================================================= -->
        <!-- TipoDesglose                                                            -->
        <!--        TipoDesglose                                                     -->
        <!--            DesgloseFactura    Facturas simplificadas y facturas resumen -->
        <!--            DesgloseTipoOperacion                                        -->
        <!--                PrestacionServicios                                      -->
        <!--                Entrega                                                  -->
        <!--                                                                         -->
        <!--  ATENCIÓN: En una misma factura puede declararse PrestacionServicios y  -->
        <!--            Entrega con exnciones distintas en ambas.                    -->
        <!--                                                                         -->
        <!-- Requiere desglose por operación si:                                     -->
        <!--     La contraparte contiene un IdOtro                                   -->
        <!--     NIF que empiece por N                                               -->
        <!-- SII 0.7 FAQ 3.11. A la hora de desglosar los datos de la factura, ¿debe indicarse si la operación es una entrega de bienes o una prestación de servicios?

                         El desglose se hará obligatoriamente a nivel de operación cuando el cliente sea extranjero (tipo “ID Otro” o NIF que empiece por N) y no sea una factura simplificada o un asiento resumen.

             Error 2006:
             La factura contiene un desglose a nivel de factura cuando le corresponde un
             desglose a nivel de operación, por no ser factura simplificada ni asiento resumen y
             la contraparte contiene un IdOtro o tiene un NIF que empiece por N.
        -->
        <!--                                                                         -->
        <!-- ======================================================================= -->
        <set name='m_tipo_desglose'>F</set>     <!-- Tipo desglose: Factura -->
        <if>
            <expr>
                <or>
<!-- fcm 
                    <isnull><contraparte_nif_spain/></isnull>
                    <string.matches><contraparte_nif_spain/><string>N*</string></string.matches>
-->
                    <isnull><m_contraparte_nif_spain/></isnull>
                    <string.matches><m_contraparte_nif_spain/><string>N*</string></string.matches>
                </or>
            </expr>
            <then>
                <!--     F2 Factura simplificada (ticket)                   -->
                <!--     F4 Asiento resumen de facturas                     -->
                <!--     R5 Factura rectificativa en facturas simplificadas -->
                <if>
                    <expr>
                        <not><string.regexp><p_tipofactura/><string>(F2|F4|R5)</string></string.regexp></not>
                    </expr>
                    <then>
                        <set name='m_tipo_desglose'>O</set>     <!-- Tipo desglose: Operación -->
                    </then>
                </if>
            </then>
        </if>

        <!-- ======================================================================= -->
        <!-- Cursor cimpcont para desglose IVA                                       -->
        <!-- ======================================================================= -->
        <set name='m_count_desglose'>0</set>
        <set name='str_desglosefactura'><string/></set>
        <set name='str_prestacionservicios'><string/></set>
        <set name='str_entrega'><string/></set>
        <foreach>
            <select prefix='cimpcont_'>
                <columns>
                    CASE WHEN <m_tipo_desglose/> = 'F' THEN 'F'     <!-- Desglose Factura -->
                         WHEN <m_tipo_desglose/> = 'O' AND (UPPER(coperimp.nomope) LIKE '%SERVICIOS%' OR UPPER(coperimp.nomope) LIKE '%SERVEIS%') THEN 'S'  <!-- Desglose Tipo Operación Servicios -->
                         WHEN <m_tipo_desglose/> = 'O' AND (UPPER(coperimp.nomope) LIKE '%BIENES%')   OR UPPER(coperimp.nomope) LIKE '%B_NS%'     THEN 'B'  <!-- Desglose Tipo Operación Bienes    -->
                         ELSE 'S'   <!-- DEFAULT: Servicios -->
                    <!-- ELSE 'X'        Error operación -->
                     END AS tipo_operacion,
                    cimpcont.*,
                    coperimp.nomope,
                    ctipoimp.nomimp,
                    CASE WHEN cimpcont.zimter IN ('ESCO', 'NAC') AND (UPPER(coperimp.nomope) LIKE '%(ISP)%' OR UPPER(coperimp.nomope) LIKE '%[ISP]%')
                              THEN 1
                              ELSE 0
                          END AS is_isp,
                    es_sii_get_is_eur ( cimpcont.zimter ) AS is_eur


<!--
select opeimp, nomope,
CASE WHEN (UPPER(nomope) LIKE '%SERVICIOS%' OR UPPER(nomope) LIKE '%SERVEIS%') THEN 'S'
     WHEN (UPPER(nomope) LIKE '%BIENES%')   OR UPPER(nomope) LIKE '%B_NS%'     THEN 'B'
     ELSE 'X'
 END AS entrega_servicios
from coperimp
order by opeimp
-->
                </columns>
                <from table='${m_cimpcont_access}' alias='cimpcont'>
                    <join type='left' table='coperimp'>
                        <on>cimpcont.opeimp = coperimp.opeimp</on>
                    </join>
                    <join type='left' table='ctipoimp'>
                        <on>cimpcont.codimp = ctipoimp.codimp</on>
                        <on>cimpcont.fecope BETWEEN ctipoimp.fecini AND ctipoimp.fecfin</on>
                    </join>
                </from>
                <where>
                        cimpcont.empcode  = <p_empcode/>
                    AND cimpcont.natfac   = <m_natfac/>
                    AND cimpcont.docser   = <p_numfactura/>
                    AND cimpcont.cif      = <cimpcont_head_cif/>
                    AND cimpcont.fecdoc   = <p_fechafactura/>
                    AND cimpcont.tipimp   = 'N'
<!--                AND cimpcont.valida  != 'R'      Excluye registros: Cobros y/o pagos RECC o  Cobros y/o pagos de certificaciones de obras -->
                    <!-- Excluye registros Post-validados de Cobros y/o pagos RECC  -->
                    AND NOT(cimpcont.valida  = 'R' AND cimpcont.cashvat = 1)
                    <!-- Excluye registros No validados de certificaciones de obras -->
                    AND NOT(cimpcont.valida  = 'N' AND cimpcont.cashvat = 0)
                    <!-- Excluimos los registros generados por el proceso de autofacturas (ISP): -->
                    AND cimpcont.docgen  != 'R'
                </where>
                <order>
                    tipo_operacion, cimpcont.imppor, cimpcont.orden
                </order>
            </select>
            <before-group of='cimpcont_tipo_operacion'>
                <if>
                    <expr>
                        <eq><cimpcont_tipo_operacion/>X</eq>
                    </expr>
                    <then>
                        <exception><string>Operación indeterminada [<cimpcont_tipo_operacion/>] para código [<cimpcont_opeimp/>]. <string.nl/><m_msg_id_factura/></string></exception>
                    </then>
                </if>
                <!-- ======================================================================= -->
                <!-- Inicializaciones                                                        -->
                <!-- ======================================================================= -->
                <set name='str_detalleiva'><string/></set>

                <!-- Acumulador base Sujeta Exenta -->
                <set name='m_causaexencion_bak'><null/></set>
                <set name='m_causaexencion'><null/></set>
                <set name='m_basimp_sujeta_exenta'>0</set>

                <!-- Acumuladores bases no sujetas -->
                <set name='m_basimp_nosujeta_por_art_14'>0</set>
                <set name='m_basimp_nosujeta_por_tai'>0</set>

                <!-- ======================================================================= -->
                <!-- L7 Calificación del tipo de operación Sujeta / No Exenta                -->
                <!--    S1 Sujeta – No exenta - Sin inversion sujeto pasivo                  -->
                <!--    S2 Sujeta – No exenta - Con Inversion sujeto pasivo                  -->
                <!--    S3 Sujeta – No exenta - Sin inversion sujeto pasivo y con Inversion sujeto pasivo -->
                <!-- ======================================================================= -->
                <set name='m_tipo_noexenta'><null/></set>
            </before-group>
            <after-group of='cimpcont_tipo_operacion'>
<!-- Ejemplo:
<sii:TipoDesglose>
<sii:DesgloseTipoOperacion>

<sii:PrestacionServicios>
<sii:Sujeta>
    <sii:Exenta>
        <sii:CausaExencion>E1</sii:CausaExencion>
        <sii:BaseImponible>5081.28</sii:BaseImponible>
    </sii:Exenta>
    NoExenta
        TipoNoExenta
        DesgloseIVA
            DetalleIVA
                TipoImpositivo
                BaseImponible
                CuotaRepercutida
                TipoRecargoEquivalencia
                CuotaRecargoEquivalencia
</sii:Sujeta>
NoSujeta
    ImportePorArticulos7_14_Otros
    ImporteTAIReglasLocalizacion
</sii:PrestacionServicios>

<sii:Entrega>
<sii:Sujeta>
    <sii:Exenta>
        <sii:CausaExencion>E2</sii:CausaExencion>
        <sii:BaseImponible>80.00</sii:BaseImponible>
    </sii:Exenta>
</sii:Sujeta>
</sii:Entrega>

</sii:DesgloseTipoOperacion>
</sii:TipoDesglose>

o

<sii:TipoDesglose>
<sii:DesgloseFactura>

<sii:Sujeta>
    <sii:Exenta>
        <sii:CausaExencion>E1</sii:CausaExencion>
        <sii:BaseImponible>5081.28</sii:BaseImponible>
    </sii:Exenta>
    NoExenta
        TipoNoExenta
        DesgloseIVA
            DetalleIVA
                TipoImpositivo
                BaseImponible
                CuotaRepercutida
                TipoRecargoEquivalencia
                CuotaRecargoEquivalencia
</sii:Sujeta>
NoSujeta
    ImportePorArticulos7_14_Otros
    ImporteTAIReglasLocalizacion

</sii:DesgloseFactura>
</sii:TipoDesglose>
-->
                <!-- ======================================================================= -->
                <!-- Sujeta: Exenta                                                          -->
                <!-- ======================================================================= -->
                <set name='str_sujeta_exenta'><string/></set>
                <if>
                    <expr>
                        <ne><m_basimp_sujeta_exenta/>0</ne>
                    </expr>
                    <then>
                        <set name='str_causaexencion'><string/></set>
                        <if>
                            <expr>
                                <isnotnull><m_causaexencion/></isnotnull>
                            </expr>
                            <then>
                                <set name='str_causaexencion'>
                                    <add><xml.sii:CausaExencion><m_causaexencion/></xml.sii:CausaExencion><string.nl/></add>
                                </set>
                            </then>
                        </if>
                        <set name='str_sujeta_exenta'>
                            <xml.sii:Exenta>
                                <str_causaexencion/><xml.sii:BaseImponible><m_basimp_sujeta_exenta/></xml.sii:BaseImponible>
                            </xml.sii:Exenta>
                        </set>
                    </then>
                </if>

                <!-- ======================================================================= -->
                <!-- Sujeta: NoExenta                                                        -->
                <!-- ======================================================================= -->
                <set name='str_sujeta_noexenta'><string/></set>
                <if>
                    <expr>
                        <gt><string.length><str_detalleiva/></string.length><number>0</number></gt>
                    </expr>
                    <then>
                        <set name='str_sujeta_noexenta'>
                            <xml.sii:NoExenta>
                                <xml.sii:TipoNoExenta><m_tipo_noexenta/></xml.sii:TipoNoExenta>
                                <xml.sii:DesgloseIVA>
                                    <str_detalleiva/>
                                </xml.sii:DesgloseIVA>
                            </xml.sii:NoExenta>
                        </set>
                    </then>
                </if>

                <!-- ======================================================================= -->
                <!-- Operaciones sujetas                                                     -->
                <!-- Tag: Sujeta.Exenta                                                      -->
                <!-- Tag: Sujeta.NoExenta                                                    -->
                <!-- ======================================================================= -->
                <set name='str_sujeta_all'><string/></set>
                <if>
                    <expr>
                        <gt><string.length><add><str_sujeta_exenta/><str_sujeta_noexenta/></add></string.length><number>0</number></gt>
                    </expr>
                    <then>
                        <set name='str_sujeta_all'>
                            <xml.sii:Sujeta>
                                <str_sujeta_exenta/>
                                <str_sujeta_noexenta/>
                            </xml.sii:Sujeta>
                        </set>
                    </then>
                </if>

                <!-- ======================================================================= -->
                <!-- Operaciones no sujetas                                                  -->
                <!--                                                                         -->
                <!-- Tag: NoSujeta.ImportePorArticulos7_14_Otros                             -->
                <!--    - Importe en euros si la sujeción es por el art. 7,14,otros          -->
                <!--                                                                         -->
                <!-- Tag: NoSujeta.ImporteTAIReglasLocalizacion                              -->
                <!--    - Importe en euros si la sujeción es por operaciones no sujetas en   -->
                <!--      el TAI por reglas de localización.                                 -->
                <!--                                                                         -->
                <!--      TAI = Se recuerda que el territorio de aplicación del impuesto en  -->
                <!--            España (TAI) comprende la Península e Islas Baleares.        -->
                <!--                                                                         -->
                <!--         Si es una operació intracomunitaria de SERVEIS asumim que el    -->
                <!--         tercer està regsitrat en el VIES                                -->      
                <!--         Si el intracomunitari no està registrat en el VIES llavors      -->      
                <!--         es probable que la AEAT generi error i s'hagi d'anul.lar        -->
                <!--         la factura per tal de generar-ne una de nova amb IVA. Es        -->
                <!--         tractaria com una factura amb zimter = NAC !                    -->
                <!--                                                                         -->
                <!--  DOC: sii/Normativa/IVA/BOE-A-1992-28925-consolidado.pdf                -->
                <!--  INFO:                                                                  -->
                <!--     https://www.boe.es/buscar/act.php?id=BOE-A-1992-28740               -->
                <!--     Ley 37/1992, de 28 de diciembre, del Impuesto sobre el Valor Añadido. -->
                <!--     TEXTO CONSOLIDADO                                                   -->
                <!--     Última modificación: 6 de diciembre de 2016                         -->
                <!--     TÍTULO II. Exenciones                                               -->
                <!--     CAPÍTULO V. Importaciones de bienes                                 -->
                <!-- Pag 21:  Artículo 14. Importaciones de bienes cuya entrega en el        -->
                <!--                       interior estuviera exenta del Impuesto.           -->
                <!-- ======================================================================= -->
                <set name='str_nosujeta_all'><string/></set>
                <if>
                    <expr>
                        <or>
                            <ne><m_basimp_nosujeta_por_art_14/>0</ne>
                            <ne><m_basimp_nosujeta_por_tai/>0</ne>
                        </or>
                    </expr>
                    <then>
                        <set name='str_nosujeta_por_art_14'><string/></set>
                        <if>
                            <expr>
                                <ne><m_basimp_nosujeta_por_art_14/>0</ne>
                            </expr>
                            <then>
                                <set name='str_nosujeta_por_art_14'><xml.sii:ImportePorArticulos7_14_Otros><m_basimp_nosujeta_por_art_14/></xml.sii:ImportePorArticulos7_14_Otros></set>
                            </then>
                        </if>
                        <set name='str_nosujeta_por_tai'><string/></set>
                        <if>
                            <expr>
                                <ne><m_basimp_nosujeta_por_tai/>0</ne>
                            </expr>
                            <then>
                                <set name='str_nosujeta_por_tai'><xml.sii:ImporteTAIReglasLocalizacion><m_basimp_nosujeta_por_tai/></xml.sii:ImporteTAIReglasLocalizacion></set>
                            </then>
                        </if>

                        <set name='str_nosujeta_all'>
                            <xml.sii:NoSujeta>
                                <str_nosujeta_por_art_14/>
                                <str_nosujeta_por_tai/>
                            </xml.sii:NoSujeta>
                        </set>
                    </then>
                </if>

                <!-- ======================================================================= -->
                <!-- TipoDesglose                                                            -->
                <!--     DesgloseFactura                                                     -->
                <!--     o                                                                   -->
                <!--     DesgloseTipoOperacion                                               -->
                <!--         PrestacionServicios                                             -->
                <!--         Entrega                                                         -->
                <!-- ======================================================================= -->
                <if>
                    <expr>
                        <eq><m_tipo_desglose/>F</eq>
                    </expr>
                    <then>
                        <if>
                            <expr>
                                <gt><string.length><str_desglosefactura/></string.length>0</gt>
                            </expr>
                            <then>
                                <exception><string>Incongruencia en [DesgloseFactura]. <string.nl/><m_msg_id_factura/></string></exception>
                            </then>
                        </if>
                        <set name='str_desglosefactura'>
                            <xml.sii:DesgloseFactura>
                                <str_sujeta_all/>
                                <str_nosujeta_all/>
                            </xml.sii:DesgloseFactura>
                        </set>
                    </then>
                    <else>
                        <if>
                            <expr>
                                <eq><cimpcont_tipo_operacion/>S</eq>
                            </expr>
                            <then>
                                <if>
                                    <expr>
                                        <gt><string.length><str_prestacionservicios/></string.length>0</gt>
                                    </expr>
                                    <then>
                                        <exception><string>Incongruencia en [PrestacionServicios]. <string.nl/><m_msg_id_factura/></string></exception>
                                    </then>
                                </if>
                                <set name='str_prestacionservicios'>
                                    <xml.sii:PrestacionServicios>
                                        <str_sujeta_all/>
                                        <str_nosujeta_all/>
                                    </xml.sii:PrestacionServicios>
                                </set>
                            </then>
                            <else>
                                <if>
                                    <expr>
                                        <gt><string.length><str_entrega/></string.length>0</gt>
                                    </expr>
                                    <then>
                                        <exception><string>Incongruencia en [Entrega]. <string.nl/><m_msg_id_factura/></string></exception>
                                    </then>
                                </if>
                                <set name='str_entrega'>
                                    <xml.sii:Entrega>
                                        <str_sujeta_all/>
                                        <str_nosujeta_all/>
                                    </xml.sii:Entrega>
                                </set>
                            </else>
                        </if>
                    </else>
                </if>
            </after-group>
            <do>

                <!-- ======================================================================= -->
                <!-- Control límite desglose                                                 -->
                <!-- ======================================================================= -->
                <set name='m_count_desglose'><add><m_count_desglose/><number>1</number></add></set>
                <set name='coperimp_nomope'><cimpcont_nomope/></set>
                <set name='ctipoimp_nomimp'><cimpcont_nomimp/></set>
                <set name='m_is_isp'><cimpcont_is_isp/></set>
                <set name='m_is_eur'><cimpcont_is_eur/></set>
                <unset name='cimpcont_nomope'/>
                <unset name='cimpcont_nomimp'/>
                <unset name='cimpcont_is_isp'/>
                <unset name='cimpcont_is_eur'/>

                <!-- ======================================================================= -->
                <!-- Determinar si son gastos suplidos y si es el caso excluir de la         -->
                <!-- declaración.                                                            -->
                <!--                                                                         -->
                <!-- Convenio, en la descripción de la operación del impuesto del ERP, si    -->
                <!-- existe la frase: *(SUP)*  o  *[SUP]*                                    -->
                <!-- se interpretará que son gastos suplidos y se descartará de presentar    -->
                <!-- al sistenma SII.                                                        -->
                <!-- ======================================================================= -->
                <if>
                    <expr>
                        <m_excluir_suplidos/>
                    </expr>
                    <then>
                        <set name='m_valor'><string>SUP</string></set>
                        <set name='m_regexp'><add><string>.*[\[(]</string><m_valor/><string>.*[\])]</string></add></set>
                        <if>
                            <expr>
                                <string.regexp><coperimp_nomope/><m_regexp/></string.regexp>
                            </expr>
                            <then>
                                <foreach.continue/>
                            </then>
                        </if>
                    </then>
                </if>

                <!-- ======================================================================= -->
                <!-- CTIPOIMP_NOMIMP                                                         -->
                <!-- ======================================================================= -->
                <if>
                    <expr>
                        <eq><string.length><ctipoimp_nomimp/></string.length>0</eq>
                    </expr>
                    <then>
                        <exception><string>No se ha informado la descripción [ctipoimp_nomimp] del tipo impositivo [<cimpcont_codimp/>]. <string.nl/><m_msg_id_factura/></string></exception>
                    </then>
                </if>

                <!-- ======================================================================= -->
                <!-- Cuota recargo de equivalencia                                           -->
                <!-- ======================================================================= -->
                <select prefix='m_'>
                    <columns>
                        MIN(cimpcont.imppor) AS porrec,
                        SUM(cimpcont.totimp) AS totrec
                    </columns>
                    <from table='${m_cimpcont_access}' alias='cimpcont' />
                    <where>
                            cimpcont.empcode  = <p_empcode/>
                        AND cimpcont.natfac   = <m_natfac/>
                        AND cimpcont.docser   = <p_numfactura/>
                        AND cimpcont.cif      = <cimpcont_cif/>
                        AND cimpcont.fecdoc   = <p_fechafactura/>
                        AND cimpcont.tipimp   = 'E'
<!--                    AND cimpcont.valida  != 'R'      Excluye registros: Cobros y/o pagos RECC o  Cobros y/o pagos de certificaciones de obras -->
                        <!-- Excluye registros Post-validados de Cobros y/o pagos RECC  -->
                        AND NOT(cimpcont.valida  = 'R' AND cimpcont.cashvat = 1)
                        <!-- Excluye registros No validados de certificaciones de obras -->
                        AND NOT(cimpcont.valida  = 'N' AND cimpcont.cashvat = 0)
                        <!-- Excluimos los registros generados por el proceso de autofacturas (ISP): -->
                        AND cimpcont.docgen  != 'R'
                        AND cimpcont.apteid   = <cimpcont_apteid/>
                        AND cimpcont.fecha    = <cimpcont_fecha/>
                        AND cimpcont.tercer   = <cimpcont_tercer/>
                        AND cimpcont.tipdir   = <cimpcont_tipdir/>
                        AND cimpcont.codimp   = <cimpcont_codimp/>
                    </where>
                </select>

                <!-- ======================================================================= -->
                <!-- Acumuladores por operaciones no sujetas                                 -->
                <!--                                                                         -->
                <!-- Tag: NoSujeta.ImportePorArticulos7_14_Otros                             -->
                <!--    - Importe en euros si la sujeción es por el art. 7,14,otros          -->
                <!--                                                                         -->
                <!-- Tag: NoSujeta.ImporteTAIReglasLocalizacion                              -->
                <!--    - Importe en euros si la sujeción es por operaciones no sujetas en   -->
                <!--      el TAI por reglas de localización.                                 -->
                <!--                                                                         -->
                <!--      TAI = Se recuerda que el territorio de aplicación del impuesto en  -->
                <!--            España (TAI) comprende la Península e Islas Baleares.        -->
                <!--                                                                         -->
                <!-- ======================================================================= -->

                <!-- ======================================================================= -->
                <!-- Ventas intracomunitarias de servicios.                                  -->
                <!--                                                                         -->
                <!-- NO SUJETAS EN EL TAI POR REGLAS DE LOCALIZACIÓN                         -->
                <!--                                                                         -->
                <!--      TAI = Se recuerda que el territorio de aplicación del impuesto en  -->
                <!--            España (TAI) comprende la Península e Islas Baleares.        -->
                <!--                                                                         -->
                <!--                                                                         -->
                <!--     SII 0.7 FAQ 3.5. ¿Cómo se registra una operación con inversión del sujeto pasivo?


                             En el caso de clientes que sean empresas españolas, el proveedor o prestador del servicio registrará los datos de la factura en el Libro registro de Facturas Expedidas consignando en el bloque funcional ”Desglose factura” la clave “S2: Sujeta – No Exenta – Inv. Suj. Pasivo”. El campo “tipo impositivo” se informará con importe cero y el de “cuota repercutida” se dejará en blanco.


                             En el caso de clientes que sean empresas comunitarias con NIF-IVA, el prestador del servicio registrará los datos de la factura en el Libro registro de Facturas Expedidas consignando en el bloque funcional ·”Desglose tipo operación” la clave “Importe no sujetas por reglas de localización”.
                -->
                <!-- ======================================================================= -->
                <set name='m_tipo_nosujeta'><null/></set>
                <if>
                    <expr>
                        <!-- Prestación de servicios intracomunitarios. -->
                        <and>
                            <eq><cimpcont_totimp/>0</eq>        <!-- 16-06-2017 Confirmat Jordi R.ll ; Evita tratar clientes intracomunitarios con cuota IVA calculada ! -->
                            <eq><cimpcont_tipo_operacion/>S</eq>
                            <m_is_eur/>
<!--                        <eq><cimpcont_zimter/>EUR</eq>  -->
                        </and>
                    </expr>
                    <then>
                        <!-- Importe no sujetas por reglas de localización en el TAI -->
                        <set name='m_tipo_nosujeta'>NS2</set>
                    </then>
                </if>

                <!-- ======================================================================= -->
                <!--    SII 0.7 FAQ 2.22. ¿Un sujeto pasivo que aplique el SII, suministrará información de las operaciones sujetas a IGIC o IPSI?
                
                        Únicamente cuando se trate de operaciones sujetas al IGIC o IPSI que no están sujetas al IVA por reglas de localización. En ningún caso se informará cuando las operaciones se realicen a través de un establecimiento permanente situado en Canarias, Ceuta y Melilla. En el campo “Clave Régimen especial o Trascendencia” se consignará el valor 08 y se registrarán como operaciones “no sujetas” en el campo de Importe no sujeto por reglas de localización, pero no debe informarse de los datos que correspondan a estos impuestos (IGIC o IPSI) al tratarse de operaciones no sujetas al IVA.

                        Error SII:
                            - Incorrecto: Si el campo ClaveRegimenEspecialOTrascendencia tiene un valor de 08 el campo ImporteTAIReglasLocalizacion del bloque NoSujeta debe estar informado
                -->
                <!-- ======================================================================= -->
                <if>
                    <expr>
                        <isnull><m_tipo_nosujeta/></isnull>
                        <and/>
                        <m_operacion_sujeta_al_ipsi_igic/>  <!-- L3 FE  08  Operaciones sujetas al IPSI / IGIC  -->
                    </expr>
                    <then>
                        <!-- Importe no sujetas por reglas de localización en el TAI -->
                        <set name='m_tipo_nosujeta'>NS2</set>
                    </then>
                </if>

                <!-- ======================================================================= -->
                <!-- Ventas intracomunitarias de Entregas de bienes.                         -->
                <!--                                                                         -->
                <!--     SII 0.7 3.6. ¿Cómo se registra una Entrega Intracomunitaria de Bienes?
                           
                             Se anotará la factura emitida al cliente comunitario en el Libro registro de Facturas Expedidas procediendo a su identificación mediante la clave 2 en el campo de tipos de Identificación en el país de residencia “IDType” y su Número de Operador Intracomunitario en el campo "ID". El campo “CodigoPais” no será obligatorio.

                             Por otra parte, la base imponible de la factura se incluirá en el campo de tipo de operación “Exenta” dentro del bloque “Entrega”. Como causa de exención se consignará la clave “E5: Exenta por el artículo 25”.
                -->
                <!-- ======================================================================= -->
                <set name='m_causaexencion'><null/></set>
                <if>
                    <expr>
                        <!-- Entregass intracomunitarias de bienes -->
                        <and>
                            <eq><cimpcont_tipo_operacion/>B</eq>
                            <m_is_eur/>
<!--                        <eq><cimpcont_zimter/>EUR</eq>  -->
                        </and>
                    </expr>
                    <then>
                        <!-- E5 Exenta por el artículo 25 - Artículo 25. Exenciones en las entregas de bienes destinados a otro Estado miembro -->
                        <set name='m_causaexencion'>E5</set>
                    </then>
                </if>

                <!-- ======================================================================= -->
                <!-- Ventas de exportación                                                   -->
                <!--                                                                         -->
                <!--     SII 0.7 3.7. ¿Cómo se registra una Exportación?
                             
                             La operación se anota en el Libro Registro de Facturas Expedidas.
                             En el campo “Clave Régimen especial o Trascendencia” se consignará el valor 02.

                             Deberá identificarse al cliente – en caso de ser extranjero- mediante el “Código país” y las claves 3 “Pasaporte”, 4 “Documento oficial de identificación expedido por el país o territorio de residencia”, 5 “Certificado de residencia” ó 6 “Otro documento probatorio” del campo “IDType”.
                             
                             Por otra parte, la base imponible de la factura se incluirá en el campo de tipo de operación “Exenta” dentro del bloque “Entrega”. Como causa de exención se consignará la clave E2 “Exenta por el artículo 21”.
                -->
                <!-- ======================================================================= -->
                <if>
                    <expr>
                        <!-- Exportación -->
                        <eq><cimpcont_zimter/>INT</eq>
                    </expr>
                    <then>
                        <!-- Exportación - Entregas de bienes Y Servicios -->
                        <!-- E2 Exenta por el artículo 21 - Artículo 21. Exenciones en las exportaciones de bienes -->
                        <set name='m_causaexencion'>E2</set>
<!--
                        <if>
                            <expr>
                                 Exportación - Entregas de bienes 
                                <eq><cimpcont_tipo_operacion/>B</eq>
                            </expr>
                            <then>
                                 Exportación - Servicios 
                                 E2 Exenta por el artículo 21 - Artículo 21. Exenciones en las exportaciones de bienes 
                                <set name='m_causaexencion'>E2</set>
                            </then>

                            <else>
                                 E3 Exenta por el artículo 22 - Artículo 22. Exenciones en las operaciones asimiladas a las exportaciones. 
                                <set name='m_causaexencion'>E3</set>

Existe duda caso que se trate de exportación por prestacióin de servicios, deberá informarse E3 ? ( Consulta pendiente MT )
    E3 Exenta por el artículo 22 - Artículo 22. Exenciones en las operaciones asimiladas a las exportaciones.
                            </else>
                        </if>
-->
                    </then>
                </if>

                <!-- ======================================================================= -->
                <!-- Customización.                                                          -->
                <!--                                                                         -->
                <!-- Informar mediante customización:                                        -->
                <!--     1) FacturasAgrupadas                                                -->
                <!-- ======================================================================= -->
                <include code='es_sii_mr_lrfe' name='detalleiva' />

                <!-- ======================================================================= -->
                <!-- Si tipo = 0% determina si:                                              -->
                <!--     1) Sujeta Exenta  ( E1, E2, E3, E4, E5 o E6 )                       -->
                <!--        o                                                                -->
                <!--     2) No Sujeta      ( NS1 o NS2  )                                    -->
                <!-- ======================================================================= -->
                <if>
                    <expr>
                        <and>
                            <isnull><m_tipo_noexenta/></isnull>
                            <eq><cimpcont_totimp/>0</eq>
                            <not><m_is_isp/></not>
                        </and>
                    </expr>
                    <then>
                        <!-- ======================================================================= -->
                        <!-- Control error doble definición a tipo cero.                             -->
                        <!-- ======================================================================= -->
                        <if>
                            <expr>
                                <and>
                                    <isnotnull><m_causaexencion/></isnotnull>
                                    <isnotnull><m_tipo_nosujeta/></isnotnull>
                                </and>
                            </expr>
                            <then>
                                <exception><string>Doble definición a tipo cero. Sujeta Exenta: [<m_causaexencion/>] y No Sujeta: [<m_tipo_nosujeta/>] <string.nl/><m_msg_id_factura/></string></exception>
                            </then>
                        </if>

                        <!-- ======================================= -->
                        <!-- Sujeta Exenta o No Sujeta               -->
                        <!-- ======================================= -->
                        <if>
                            <expr>
                                <and>
                                    <isnull><m_causaexencion/></isnull>
                                    <isnull><m_tipo_nosujeta/></isnull>
                                </and>
                            </expr>
                            <then>
                                <!-- ======================================= -->
                                <!-- Sujeta Exenta                           -->
                                <!-- ESSE1  a  ESSE6                         -->
                                <!--    m_causaexencion = E1, E2, .. E6      -->
                                <!--    m_basimp_sujeta_exenta               -->
                                <!--   ( ES España ; S: Sujeto ; E: Exento ) -->
                                <!-- ======================================= -->
                                <for name='m_num' start='1' end='6'>
                                    <do>
                                        <set name='m_valor'><add><string>ESSE</string><string><m_num/></string></add></set>
                                        <set name='m_regexp'><add><string>.*[\[(]</string><m_valor/><string>.*[\])]</string></add></set>
                                        <if>
                                            <expr>
                                                <or>
                                                    <eq><cimpcont_codimp/><m_valor/></eq>
                                                    <string.regexp><ctipoimp_nomimp/><m_regexp/></string.regexp>
                                                </or>
                                            </expr>
                                            <then>
                                                <set name='m_causaexencion'><add><string>E</string><string><m_num/></string></add></set>
                                            </then>
                                        </if>
                                    </do>
                                </for>
                            </then>
                        </if>

                        <!-- ======================================= -->
                        <!-- No Sujeta                               -->
                        <!--    ESNS1  m_basimp_nosujeta_por_art_14  -->
                        <!--    ESNS2  m_basimp_nosujeta_por_tai     -->
                        <!--    ( ES España ; NS: No Sujeto )        -->
                        <!-- ======================================= -->
                        <if>
                            <expr>
                                <and>
                                    <isnull><m_causaexencion/></isnull>
                                    <isnull><m_tipo_nosujeta/></isnull>
                                </and>
                            </expr>
                            <then>
                                <for name='m_num' start='1' end='2'>
                                    <do>
                                        <set name='m_valor'><add><string>ESNS</string><string><m_num/></string></add></set>
                                        <set name='m_regexp'><add><string>.*[\[(]</string><m_valor/><string>.*[\])]</string></add></set>
                                        <if>
                                            <expr>
                                                <or>
                                                    <eq><cimpcont_codimp/><m_valor/></eq>
                                                    <string.regexp><ctipoimp_nomimp/><m_regexp/></string.regexp>
                                                </or>
                                            </expr>
                                            <then>
                                                <set name='m_tipo_nosujeta'><add><string>NS</string><string><m_num/></string></add></set>
                                            </then>
                                        </if>
                                    </do>
                                </for>
                            </then>
                        </if>
                    </then>
                </if>

                <!-- ======================================================================= -->
                <!-- sii:BaseImponibleACoste                                                 -->
                <!--     Para grupos de IVA                                                  -->
                <!--                                                                         -->
                <!-- ClaveRegimenEspecialOTrascendencia   (Emitidas y Recibidas)             -->
                <!--                                                                         -->
                <!-- L3 FE  06  Régimen especial grupo de entidades en IVA (Nivel Avanzado)  -->
                <!-- L3 FR  06  Régimen especial grupo de entidades en IVA (Nivel Avanzado)  -->
                <!--                                                                         -->
                <!-- ======================================================================= -->
                <if>
                    <expr>
                        <and>
                            <eq><p_claveoperacion/><string>06</string></eq>
                            <isnotnull><cempresa_grpent/></isnotnull>
                            <eq><cimpcont_imppor/>0</eq>
<!-- fcm - Ver nota en foreach.continue
                            <isnull><m_causaexencion/></isnull>      No es Sujeta Exenta !  -->
                            <isnull><m_tipo_nosujeta/></isnull>     <!-- Tampoco es NO Sujeta ! -->
                        </and>
                    </expr>
                    <then>
                        <!-- ======================================================================= -->
                        <!-- Acumula la base imponible a coste.                                      -->
                        <!-- ======================================================================= -->
                        <set name='m_baseimponibleacoste'><add><m_baseimponibleacoste/><cimpcont_basimp/></add></set>
                        <!-- 
                        <foreach.continue/>

fcm No saltamos con foreach.continue para forzar que acumule como Sujeta y Exenta porqué si cuando es tipo CERO acumulamos 
    solo en BaseImponibleACoste en facturas con una sola base donde el 100% es tipoe CERO SII requiere que informemos al menos 
    un registro en Sujeta o bien un registro en No Sujeta generando error Incorrecto:

    Error 1141
    Las operaciones podrán tener parte sujeta y parte no sujeta. Por tanto, puede aparecer solo un bloque o ambos, pero al menos debe aparecer uno (Sujeta y/o No sujeta)




                        -->
                    </then>
                </if>

                <!-- ======================================================================= -->
                <!-- Acumuladores por operaciones no sujetas                                 -->
                <!--                                                                         -->
                <!-- Tag: NoSujeta.ImportePorArticulos7_14_Otros                             -->
                <!--    - Importe en euros si la sujeción es por el art. 7,14,otros          -->
                <!--                                                                         -->
                <!-- Tag: NoSujeta.ImporteTAIReglasLocalizacion                              -->
                <!--    - Importe en euros si la sujeción es por operaciones no sujetas en   -->
                <!--      el TAI por reglas de localización.                                 -->
                <!--      Ejemplos: Operaciones intracomunitarias de servicios.   -->
                <!--                SII 0.7 Ver FAQ 3.5. ¿Cómo se registra una operación con inversión del sujeto pasivo? -->
                <!--                                                                         -->
                <!--      TAI = Se recuerda que el territorio de aplicación del impuesto en  -->
                <!--            España (TAI) comprende la Península e Islas Baleares.        -->
                <!--                                                                         -->
                <!--  DOC: sii/Normativa/IVA/BOE-A-1992-28925-consolidado.pdf                -->
                <!--  INFO:                                                                  -->
                <!--     https://www.boe.es/buscar/act.php?id=BOE-A-1992-28740               -->
                <!--     Ley 37/1992, de 28 de diciembre, del Impuesto sobre el Valor Añadido. -->
                <!--     TEXTO CONSOLIDADO                                                   -->
                <!--     Última modificación: 6 de diciembre de 2016                         -->
                <!--     TÍTULO II. Exenciones                                               -->
                <!--     CAPÍTULO V. Importaciones de bienes                                 -->
                <!-- Pag 21:  Artículo 14. Importaciones de bienes cuya entrega en el        -->
                <!--                       interior estuviera exenta del Impuesto.           -->
                <!-- ======================================================================= -->
                <if>
                    <expr>
<!-- fcm 09-06-2017
                        <and>
                            <eq><cimpcont_totimp/>0</eq>
                            <isnull><m_causaexencion/></isnull>
                            <isnotnull><m_tipo_nosujeta/></isnotnull>
                        </and>
-->
                        <isnotnull><m_tipo_nosujeta/></isnotnull>
                    </expr>
                    <then>

                        <!-- ======================================================================= -->
                        <!--                                                                         -->
                        <!-- ======================================================================= -->
                        <if>
                            <expr>
                                <eq><m_tipo_nosujeta/>NS1</eq>
                            </expr>
                            <then>
                                <!-- ======================================================================= -->
                                <!-- Comprobación importe cuota igual a CERO.                                -->
                                <!-- ======================================================================= -->
                                <if>
                                    <expr>
                                        <ne><cimpcont_totimp/>0</ne>
                                    </expr>
                                    <then>
                                        <exception><string>Las operaciones no sujetas por artículo 7, 14 u otros deben tener importe CERO en la cuota del impuesto.<string.nl/><m_msg_id_factura/></string></exception>
                                    </then>
                                </if>

                                <!-- Una vez acumulado el importe debe continuar al siguiente registro. -->
                                <set name='m_basimp_nosujeta_por_art_14'><add><m_basimp_nosujeta_por_art_14/><cimpcont_basimp/></add></set>
                                <foreach.continue/>
                            </then>
                        </if>

                        <!-- ======================================================================= -->
                        <!--                                                                         -->
                        <!-- ======================================================================= -->
                        <if>
                            <expr>
                                <eq><m_tipo_nosujeta/>NS2</eq>
                            </expr>
                            <then>
                                <!-- ======================================================================= -->
                                <!-- Comprobación importe cuota igual a CERO si no es IPSI/IGIC.             -->
                                <!--                                                                         -->
                                <!-- EMPRESAS SIN ESTABLECIMIENTO PERMANENTE EN CANARIAS:                    -->
                                <!--                                                                         -->
                                <!-- Desde península se pueden realizar operaciones de ventas a Canarias     -->
                                <!-- con cargos IGIC en la factura. Estas cuotas no se delcaran en el censo  -->
                                <!-- SII pero la base se declara como NoSujeta.ImporteTAIReglasLocalizacion  -->
                                <!-- ======================================================================= -->
                                <if>
                                    <expr>
                                        <not><m_operacion_sujeta_al_ipsi_igic/></not>  <!-- L3 FE  08  Operaciones sujetas al IPSI / IGIC  -->
                                        <and/>
                                        <ne><cimpcont_totimp/>0</ne>
                                    </expr>
                                    <then>
                                        <exception><string>Las operaciones no sujetas por TAI reglas de localización deben tener importe CERO en la cuota del impuesto. Operación sujeta al IPSI IGIC: [<m_operacion_sujeta_al_ipsi_igic/>]<string.nl/><m_msg_id_factura/></string></exception>
                                    </then>
                                </if>

                                <!-- Una vez acumulado el importe debe continuar al siguiente registro. -->
                                <set name='m_basimp_nosujeta_por_tai'><add><m_basimp_nosujeta_por_tai/><cimpcont_basimp/></add></set>
                                <foreach.continue/>
                            </then>
                        </if>
                    </then>
                </if>

                <!-- ======================================================================= -->
                <!-- Facturas emitidas                                                       -->
                <!--     1) Operaciones Sujetas Exentas                                      -->
                <!--     2) Acumuladores por operaciones no sujetas                          -->
                <!--                                                                         -->
                <!-- Tag: Sujeta.Exenta.CausaExencion                                        -->
                <!--    - Campo que especifica la causa de la exención en los supuestos      -->
                <!--      que aplique.                                                       -->
                <!--    - L9 Causa de exención de operaciones sujetas y exentas              -->
                <!--          E1 Exenta por el artículo 20 - Artículo 20. Exenciones en operaciones interiores.      -->
                <!--          E2 Exenta por el artículo 21 - Artículo 21. Exenciones en las exportaciones de bienes  -->
                <!--          E3 Exenta por el artículo 22 - Artículo 22. Exenciones en las operaciones asimiladas a las exportaciones.          -->
                <!--          E4 Exenta por el artículo 24 - Artículo 24. Exenciones relativas a regímenes aduaneros y fiscales                  -->
                <!--          E5 Exenta por el artículo 25 - Artículo 25. Exenciones en las entregas de bienes destinados a otro Estado miembro  -->
                <!--          E6 Exenta por otros                                            -->
                <!--                                                                         -->
                <!--          Artículo no contemplado: Artículo 23. Exenciones relativas a las zonas francas, depósitos francos y otros depósitos   -->                                 -->
                <!--                                                                         -->
                <!-- Tag: Sujeta.Exenta.BaseImponible                                        -->
                <!--    - Importe en euros correspondiente a la parte Sujeta / Exenta        -->
                <!--                                                                         -->
                <!--  DOC: sii/Normativa/IVA/BOE-A-1992-28925-consolidado.pdf                -->
                <!--  INFO:                                                                  -->
                <!--     https://www.boe.es/buscar/act.php?id=BOE-A-1992-28740               -->
                <!--     Ley 37/1992, de 28 de diciembre, del Impuesto sobre el Valor Añadido. -->
                <!--     TEXTO CONSOLIDADO                                                   -->
                <!--     Última modificación: 6 de diciembre de 2016                         -->
                <!--     TÍTULO II. Exenciones                                               -->
                <!-- Pag 14: CAPÍTULO I. Entregas de bienes y prestaciones de servicios      -->
                <!-- ======================================================================= -->
                <if>
                    <expr>
                        <and>
                            <eq><cimpcont_totimp/>0</eq>
                            <isnull><m_tipo_nosujeta/></isnull>
                            <isnull><m_tipo_noexenta/></isnull>          <!-- Sujeta / No exenta -->
                            <not><m_is_isp/></not>
                        </and>
                    </expr>
                    <then>
                        <if>
                            <expr>
                                <isnull><m_causaexencion/></isnull>
                            </expr>
                            <then>
                                <set name='m_causaexencion'>E1</set>    <!-- Valor preferente por defecto: -->
                                                                        <!-- E1 Exenta por el artículo 20 - Artículo 20. Exenciones en operaciones interiores. -->
                            </then>
                        </if>
                        <if>
                            <expr>
                                <isnull><m_causaexencion_bak/></isnull>
                            </expr>
                            <then>
                                <set name='m_causaexencion_bak'><m_causaexencion/></set>
                            </then>
                        </if>
                        <!-- ======================================================================= -->
                        <!-- En unn factura sin deglose de operación la exención debe ser del mismo  -->
                        <!-- tipo.                                                                   -->
                        <!-- Si la factura tiene desglose de operacion (Servicios y/o Entregas ,     -->
                        <!-- entonces se admite una exención por operación.                          -->
                        <!-- ======================================================================= -->
                        <if>
                            <expr>
                                <ne><m_causaexencion_bak/><m_causaexencion/></ne>
                            </expr>
                            <then>
                                <exception><string>Discrepancia en Sujetas y Exentas por causa del tipo de exención. [<m_causaexencion_bak/>] vs [<m_causaexencion/>]<string.nl/><m_msg_id_factura/></string></exception>
                            </then>
                        </if>
                        <!-- Una vez acumulado el importe debe continuar al siguiente registro. -->
                        <set name='m_basimp_sujeta_exenta'><add><m_basimp_sujeta_exenta/><cimpcont_basimp/></add></set>
                        <foreach.continue/>
                    </then>
                </if>

                <!-- ======================================================================= -->
                <!-- Facturas emitidas                                                       -->
                <!-- Sujeta y No exenta                                                      -->
                <!-- ======================================================================= -->
                <if>
                    <expr>
                        <or>
                            <gt><cimpcont_imppor/>0</gt>
                            <m_is_isp/>
                        </or>
                    </expr>
                    <then>
                        <!-- ======================================================================= -->
                        <!-- L7 Calificación del tipo de operación Sujeta / No Exenta                -->
                        <!--    S1 Sujeta – No exenta - Sin inversion sujeto pasivo                  -->
                        <!--    S2 Sujeta – No exenta - Con Inversion sujeto pasivo                  -->
                        <!--    S3 Sujeta – No exenta - Sin inversion sujeto pasivo y con Inversion sujeto pasivo -->
                        <!--                                                                         -->
                        <!-- Operaciones ISP: ( Ventas a tipo cero )                                 -->     
                        <!--        1) Ventas de productois de reciclaje y chatarrería.              -->
                        <!--        2) Operaciones de venta de constructoras obligadas a aplicar     -->
                        <!--           ISP Inversión del Sujeto Pasivo. En este caso la constructora -->
                        <!--           no puede repercutirse el IVA y es el comparador el obligado a -->
                        <!--           autorepercutirse el IVA.                                      -->
                        <!--                                                                         -->
                        <!-- ISP: La AEAT desde el año 2012, por causa de la crisis inmobiliaria,    -->
                        <!-- responsabilizó de liquidar el IVA al comprador para evitar posible      -->
                        <!-- fraude del vendedor.                                                    -->
                        <!--                                                                         -->
                        <!-- El vendendor (constructora) no repercute el IVA (totimp = 0) y declara  -->
                        <!-- la operación como Sujeta y No exenta de tipo:                           -->
                        <!--                                                                         -->
                        <!--     S2 Sujeta – No exenta - Con Inversion sujeto pasivo                 -->
                        <!--                                                                         -->
                        <!-- El comprador por su parte declarará la operación como ISP y calculará   -->
                        <!-- el IVA que le correpsonde liquidar (soportar y repercutir) por cuenta   -->
                        <!-- del cliente (constructora).                                             -->
                        <!--                                                                         -->
                        <!-- SII 0.7 FAQ 3.5. ¿Cómo se registra una operación con inversión del sujeto pasivo?
                        
                                     En el caso de clientes que sean empresas españolas, el proveedor o prestador del servicio registrará los datos de la factura en el Libro registro de Facturas Expedidas consignando en el bloque funcional ”Desglose factura” la clave “S2: Sujeta – No Exenta – Inv. Suj. Pasivo”. El campo “tipo impositivo” se informará con importe cero y el de “cuota repercutida” se dejará en blanco.
                        -->
                        <!-- ======================================================================= -->
                        <if>
                            <expr>
                                <isnull><m_tipo_noexenta/></isnull>
                            </expr>
                            <then>
                                <set name='m_tipo_noexenta'>S1</set>
                                <if>
                                    <expr>
                                        <m_is_isp/>
                                    </expr>
                                    <then>
                                        <set name='m_tipo_noexenta'>S2</set>
                                    </then>
                                </if>
                            </then>
                            <else>
                                <if>
                                    <expr>
                                        <and>
                                            <eq><m_tipo_noexenta/>S1</eq>
                                            <m_is_isp/>
                                        </and>
                                    </expr>
                                    <then>
                                        <set name='m_tipo_noexenta'>S3</set>
                                    </then>
                                </if>
                                <if>
                                    <expr>
                                        <and>
                                            <eq><m_tipo_noexenta/>S2</eq>
                                            <not><m_is_isp/></not>
                                        </and>
                                    </expr>
                                    <then>
                                        <set name='m_tipo_noexenta'>S3</set>
                                    </then>
                                </if>
                            </else>
                        </if>

                        <set name='str_recargoequivalencia'><string/></set>
                        <if>
                            <expr>
                                <isnotnull><m_porrec/></isnotnull>
                            </expr>
                            <then>
                                <!-- El valor de cimpcont_imppor en la base de datos es de tres decimales, lo reducimos a dos y convertimos a punto. -->
                                <set name='m_str_porrec'><number.format format='#.##' minimumfractiondigits='2' maximumfractiondigits='2'><m_porrec/></number.format></set>
                                <set name='m_str_porrec'><string.replace><m_str_porrec/><string>,</string><string>.</string></string.replace></set>
                                <set name='str_recargoequivalencia'>
                                    <add>
                                        <string.nl/>
                                        <xml.sii:TipoRecargoEquivalencia><m_str_porrec/></xml.sii:TipoRecargoEquivalencia>
                                        <xml.sii:CuotaRecargoEquivalencia><m_totrec/></xml.sii:CuotaRecargoEquivalencia>
                                    </add>
                                </set>
                            </then>
                        </if>

                        <if>
                            <expr>
                                <m_is_isp/>
                            </expr>
                            <then>
                                <if>
                                    <expr>
                                        <or>
                                            <ne><cimpcont_imppor/>0</ne>
                                            <ne><m_porrec/>0</ne>
                                        </or>
                                    </expr>
                                    <then>
                                        <exception><string>Operación de Inversión del Sujeto Pasivo (ISP) con tipos impositivos distintos de cero. <string.nl/><m_msg_id_factura/></string></exception>
                                    </then>
                                </if>
                            </then>
                        </if>

                        <!-- El valor de cimpcont_imppor en la base de datos es de tres decimales, lo reducimos a dos y convertimos a punto. -->
                        <set name='m_str_imppor'><number.format format='#.##' minimumfractiondigits='2' maximumfractiondigits='2'><cimpcont_imppor/></number.format></set>
                        <set name='m_str_imppor'><string.replace><m_str_imppor/><string>,</string><string>.</string></string.replace></set>
                        <set name='str_detalleiva'>
                            <add>
                                <str_detalleiva/>
                                <xml.sii:DetalleIVA>
                                    <xml.sii:TipoImpositivo><m_str_imppor/></xml.sii:TipoImpositivo>
                                    <xml.sii:BaseImponible><cimpcont_basimp/></xml.sii:BaseImponible>
                                    <xml.sii:CuotaRepercutida><cimpcont_totimp/></xml.sii:CuotaRepercutida><str_recargoequivalencia/>
                                </xml.sii:DetalleIVA>
                            </add>
                        </set>
                    </then>
                </if>

            </do>
        </foreach>

        <!-- ======================================================================= -->
        <!-- Control desglose                                                        -->
        <!-- ======================================================================= -->
        <if>
            <expr>
                <eq><m_count_desglose/><number>0</number></eq>
            </expr>
            <then>
                <exception><string>No se ha encontrado ningún registro de detalle. <string.nl/><m_msg_id_factura/></string></exception>
            </then>
        </if>
        <if>
            <expr>
                <eq><p_importetotal/><number>0</number></eq>
            </expr>
            <then>
                <exception><string>Importe total de factura igual a cero. <string.nl/><m_msg_id_factura/></string></exception>
            </then>
        </if>

        <!-- ======================================================================= -->
        <!-- TipoDesglose                                                            -->
        <!--     DesgloseFactura                                                     -->
        <!--     o                                                                   -->
        <!--     DesgloseTipoOperacion                                               -->
        <!--         PrestacionServicios                                             -->
        <!--         Entrega                                                         -->
        <!-- ======================================================================= -->
        <if>
            <expr>
                <eq><m_tipo_desglose/>F</eq>
            </expr>
            <then>
                <set name='str_tipodesglose'>
                    <xml.sii:TipoDesglose>
                        <str_desglosefactura/>
                    </xml.sii:TipoDesglose>
                </set>
            </then>
            <else>
                 <set name='str_tipodesglose'>
                    <xml.sii:TipoDesglose>
                        <xml.sii:DesgloseTipoOperacion>
                            <str_prestacionservicios/>
                            <str_entrega/>
                        </xml.sii:DesgloseTipoOperacion>
                    </xml.sii:TipoDesglose>
                </set>
            </else>
        </if>

        <!-- ======================================================================= -->
        <!-- siiLR:RegistroLRFacturasEmitidas                                        -->
        <!-- ======================================================================= -->

        <!-- ======================================================================= -->
        <!-- siiLR:IDFactura                                                         -->
        <!-- ======================================================================= -->
        <set name='str_idfactura'>
            <xml.siiLR:IDFactura>
                <xml.sii:IDEmisorFactura>
                    <xml.sii:NIF><p_idemisor/></xml.sii:NIF>
                </xml.sii:IDEmisorFactura>
                <xml.sii:NumSerieFacturaEmisor><p_numfactura/></xml.sii:NumSerieFacturaEmisor><str_numseriefacturaemisorresumenfin/>
                <xml.sii:FechaExpedicionFacturaEmisor><date.format format='dd-MM-yyyy'><p_fechafactura/></date.format></xml.sii:FechaExpedicionFacturaEmisor>
            </xml.siiLR:IDFactura>
        </set>

        <!-- ======================================================================= -->
        <!-- L5 Tipo de Factura Rectificativa                                        -->
        <!--     S Por sustitución                                                   -->
        <!--     I Por diferencias (cas normal)                                      -->
        <!-- ======================================================================= -->
        <set name='str_tiporectificativa'><string/></set>
        <set name='str_facturasrectificadas'><string/></set>
        <if>
            <expr>
                <string.regexp><p_tipofactura/><string>R.*</string></string.regexp>			
				<!-- CURSACH
                <or>
                    <lt><p_importetotal/><number>0</number></lt>
                    <isnotnull><cimpcont_docrec/></isnotnull>
                    <isnotnull><cimpcont_fecrec/></isnotnull>
                </or>
				-->
            </expr>
            <then>
<!-- Test fra negativa sin docrec ni fecrec ( Ej: cimpcont.orden = 10326339 )
                <if>
                    <expr>
                        <not><string.regexp><p_tipofactura/><string>R.*</string></string.regexp></not>
                    </expr>
                    <then>
                        <exception><string>Error tipo de factura [<p_tipofactura/>] en documento rectificativo. <string.nl/><m_msg_id_factura/></string></exception>
                    </then>
                </if>
-->
                <!-- Una factura negatuva sin información de la factura rectificada puede ser -->
                <!-- de tipo factura F1 , en tal caso no puede informarse TipoRectificativa   -->
                <if>
                    <expr>
                        <string.regexp><p_tipofactura/><string>R.*</string></string.regexp>
                    </expr>
                    <then>
                        <!-- Rectificativa por diferencias -->
                        <set name='str_tiporectificativa'><xml.sii:TipoRectificativa>I</xml.sii:TipoRectificativa></set>
						
						<!-- ================================================================ -->
						<!-- Buscamos el tipo de Rectificativa en gvenfach.auxchr2            -->												
						<!-- ================================================================ -->
						
						<select prefix='m_'>
							<columns>auxnum3 tiprec</columns>
							<from table='gvenfach'/>
							<where>gvenfach.docser = <p_numfactura/></where>
						</select>

						<if>
							<expr>
								<isnull><m_tiprec/></isnull>
							</expr>
							<then>
								<exception>No se ha definido tipo de Rectificativa en <p_numfactura/></exception>
							</then>
						</if>

						<if>
							<expr>
								<eq><m_tiprec/>0</eq>
							</expr>
							<then>
								<set name='m_tiprec'>S</set>	<!-- Sustitutiva -->
							</then>
						</if>
						<if>
							<expr>
								<eq><m_tiprec/>1</eq>
							</expr>
							<then>
								<set name='m_tiprec'>I</set>	<!-- Diferencias -->
							</then>
						</if>
						
						
						<set name='str_tiporectificativa'><xml.sii:TipoRectificativa><m_tiprec/></xml.sii:TipoRectificativa></set>
						
						<!-- ======================================================================== -->
						<!-- Si es rectificativa por Sustitución hay que especificar base rectificada -->												
						<!-- y cuota rectificada. Pero como vamos a usar la opción 2 (F1 negativa +   -->
						<!-- Rx de tipo sustitutiva, pueden ser 0                                     -->
						<!-- ======================================================================== -->

						<if>
							<expr>
								<eq><m_tiprec/>S</eq>
							</expr>
							<then>
								<set name='str_tiporectificativa'>
								    <string><str_tiporectificativa/>
									<xml.sii:ImporteRectificacion>
										<xml.sii:BaseRectificada>0</xml.sii:BaseRectificada>
										<xml.sii:CuotaRectificada>0</xml.sii:CuotaRectificada>
									</xml.sii:ImporteRectificacion>
									</string>
								</set>
							</then>
						</if>						

						
                    </then>
                </if>
<!--
<sii:TipoFactura>R2</sii:TipoFactura>
<sii:TipoRectificativa>I</sii:TipoRectificativa>
<sii:FacturasRectificadas>
<sii:IDFacturaRectificada>
<sii:NumSerieFacturaEmisor>00000000000000000000000500002000000000000000000000000000014</sii:NumSerieFacturaEmisor>
<sii:FechaExpedicionFacturaEmisor>01-03-2015</sii:FechaExpedicionFacturaEmisor>
</sii:IDFacturaRectificada>
</sii:FacturasRectificadas>
<sii:ClaveRegimenEspecialOTrascendencia>05</sii:ClaveRegimenEspecialOTrascendencia>
-->
                <set name='str_id_rect_numseriefacturaemisor'><string/></set>
                <if>
                    <expr>
                        <isnotnull><cimpcont_docrec/></isnotnull>
                    </expr>
                    <then>
                        <set name='str_id_rect_numseriefacturaemisor'><xml.sii:NumSerieFacturaEmisor><cimpcont_docrec/></xml.sii:NumSerieFacturaEmisor></set>
                    </then>
                </if>
                <set name='str_id_rect_fechaexpedicionfacturaemisor'><string/></set>
                <if>
                    <expr>
                        <isnotnull><cimpcont_fecrec/></isnotnull>
                    </expr>
                    <then>
                        <set name='str_id_rect_fechaexpedicionfacturaemisor'><xml.sii:FechaExpedicionFacturaEmisor><cimpcont_fecrec/></xml.sii:FechaExpedicionFacturaEmisor></set>
                    </then>
                </if>
                <if>
                    <expr>
                        <or>
                            <isnotnull><cimpcont_docrec/></isnotnull>
                            <isnotnull><cimpcont_fecrec/></isnotnull>
                        </or>
                    </expr>
                    <then>
                        <set name='str_facturasrectificadas'>
                            <xml.sii:FacturasRectificadas>
                                <xml.sii:IDFacturaRectificada>
                                    <str_id_rect_numseriefacturaemisor/>
                                    <str_id_rect_fechaexpedicionfacturaemisor/>
                                </xml.sii:IDFacturaRectificada>
                            </xml.sii:FacturasRectificadas>
                        </set>
                    </then>
                </if>
            </then>
        </if>

        <!-- ======================================================================= -->
        <!-- FechaOperacion                                                          -->
        <!-- ======================================================================= -->
        <set name='str_fechaoperacion'><string/></set>
        <if>
            <expr>
                <ne><cimpcont_fecope/><p_fechafactura/></ne>
            </expr>
            <then>
                <set name='str_fechaoperacion'><xml.sii:FechaOperacion><date.format format='dd-MM-yyyy'><cimpcont_fecope/></date.format></xml.sii:FechaOperacion></set>
            </then>
        </if>

        <!-- ======================================================================= -->
        <!-- Claves que identificarán las claves de régimen especial o               -->
        <!-- transcendencia tributaria.                                              -->
        <!--                                                                         -->
        <!-- Etiquetas:                                                              -->
        <!--     ClaveRegimenEspecialOTrascendencia                                  -->
        <!--     ClaveRegimenEspecialOTrascendenciaAdicional1                        -->
        <!--     ClaveRegimenEspecialOTrascendenciaAdicional2                        -->
        <!--                                                                         -->
        <!-- SII    17-05-2017    Versión 0.7                                        -->
        <!--                                                                         -->
        <!-- Tipos de operaciones para facturas emitidas                             -->
        <!-- ===========================================                             -->
        <!-- L3 FE  01  Operación de régimen general                                 -->
        <!-- L3 FE  02  Exportación                                                  -->
        <!-- L3 FE  03  Régimen especial de bienes usados, objetos de arte           -->
        <!-- L3 FE  04  Régimen especial del oro de inversión                        -->
        <!-- L3 FE  05  Régimen especial de las agencias de viajes                   -->
        <!-- L3 FE  06  Régimen especial grupo de entidades en IVA (Nivel Avanzado)  -->
        <!-- L3 FE  07  Régimen especial del criterio de caja                        -->
        <!-- L3 FE  08  Operaciones sujetas al IPSI / IGIC                           -->
        <!-- L3 FE  09  Facturación prestaciones de servicios agencias de viaje      -->
        <!-- L3 FE  10  Cobros por cuenta de terceros de honorarios profesionales... -->
        <!-- L3 FE  11  Arrendamiento local de negocio sujetas a retención           -->
        <!-- L3 FE  12  Arrendamiento local de negocio no sujetas a retención        -->
        <!-- L3 FE  13  Arrendamiento de local de negocio sujetas y no sujetas a ret -->
        <!-- L3 FE  14  Factura con IVA no devengado en certificaciones de obra AAPP -->
        <!-- L3 FE  15  Factura con IVA pendiente de devengo en op. tracto sucesivo  -->
        <!-- L3 FE  16  Primer semestre 2017                                         -->
        <!--                                                                         -->
        <!-- Tipos de operaciones para facturas recibidas                            -->
        <!-- ============================================                            -->
        <!-- L3 FR  01  Operación de régimen general                                 -->
        <!-- L3 FR  02  Compensaciones a personas acogidas al REAGYP                 -->
        <!-- L3 FR  03  Régimen especial de bienes usados, objetos de arte           -->
        <!-- L3 FR  04  Régimen especial del oro de inversión                        -->
        <!-- L3 FR  05  Régimen especial de las agencias de viajes                   -->
        <!-- L3 FR  06  Régimen especial grupo de entidades en IVA (Nivel Avanzado)  -->
        <!-- L3 FR  07  Régimen especial del criterio de caja                        -->
        <!-- L3 FR  08  Operaciones sujetas al IPSI / IGIC                           -->
        <!-- L3 FR  09  Adquisiciones intracomunitarias de bienes y prest.servicios  -->
        <!-- L3 FR  12  Operaciones de arrendamiento de local de negocio             -->
        <!-- L3 FR  13  Factura correspondiente a una importación (sin DUA)          -->
        <!-- L3 FR  14  Primer semestre 2017                                         -->
        <!--                                                                         -->
        <!-- ======================================================================= -->

        <!-- ======================================================================= -->
        <!-- L3 FE  07  Régimen especial criterio de caja                            -->
        <!--     *** NO SOPORTADA LA COMUNIACIÓN DE LOS PAGOS ***                    -->
        <!-- ======================================================================= -->
<!--
        <if>
            <expr>
                <eq><cimpcont_cashvat/>1</eq>
            </expr>
            <then>
                <if>
                    <expr>
                        <ne><p_claveoperacion/><string>07</string></ne>
                    </expr>
                    <then>
                        <exception><string>Operación RECC. Error clave de operación [<p_claveoperacion/>] en documento. <string.nl/><m_msg_id_factura/></string></exception>
                    </then>
                </if>
            </then>
        </if>
-->

        <!-- ======================================================================= -->
        <!-- IPSI / IGIC Facturas emitidas y facturas recibidasa                     -->
        <!-- L3 FE  08  Operaciones sujetas al IPSI / IGIC                           -->
        <!-- L3 FR  08  Operaciones sujetas al IPSI / IGIC                           -->
        <!-- ======================================================================= -->
<!-- fcm 09-06-2017 NO APLICAR:
        <if>
            <expr>
                <string.regexp><cimpcont_zimter/><string>(ESIC|CAN)</string></string.regexp>
            </expr>
            <then>
                <if>
                    <expr>
                        <ne><p_claveoperacion/><string>08</string></ne>
                    </expr>
                    <then>
                        <exception><string>Error clave de operación [<p_claveoperacion/>] en operación sujeta al IPSI / IGIC. <string.nl/><m_msg_id_factura/></string></exception>
                    </then>
                </if>
            </then>
        </if>
-->

        <!-- ======================================================================= -->
        <!-- Las facturas emitidas a zona impositiva del cliente INT Internacional   -->
        <!-- tienen clave de operación:                                              -->
        <!--                                                                         -->
        <!--    L3 FE  02  Exportación                                               -->
        <!--                                                                         -->
        <!-- ======================================================================= -->
        <if>
            <expr>
                <eq><cimpcont_zimter/><string>INT</string></eq>
            </expr>
            <then>
                <if>
                    <expr>
                        <ne><p_claveoperacion/><string>02</string></ne>
                    </expr>
                    <then>
                        <exception><string>Error clave de operación [<p_claveoperacion/>] en operación de exportación. <string.nl/><m_msg_id_factura/></string></exception>
                    </then>
                </if>
            </then>
        </if>

        <!-- ======================================================================= -->
        <!-- CONTRAPARTE_NOMBRERAZON                                                 -->
        <!-- ======================================================================= -->

		<select prefix='m_'>
			<columns>COUNT(*) contar</columns>
			<from table='ctercero'/>
			<where>cif = <cimpcont_cif/></where>
		</select>		
		
		<if>
			<expr>
				<eq><m_contar/>1</eq>
			</expr>
			<then>

				<select prefix='m_'>
					<columns>nombre</columns>
					<from table='ctercero'/>
					<where>cif = <cimpcont_cif/></where>
				</select>	
				<if>
					<expr>
						<isnotnull><m_nombre/></isnotnull>
					</expr>
					<then>
						<set name='cimpcont_nombre'><m_nombre/></set>
					</then>
				</if>
					
			</then>
		</if>				
		
		
        <set name='m_contraparte_nombrerazon'><local_str_fixlen><cimpcont_nombre/><number>120</number></local_str_fixlen></set>

        <!-- ======================================================================= -->
        <!-- IDType                                                                  -->
        <!-- L4 Tipos de Identificación en el país de residencia  (Pag 71)           -->
        <!--    02 NIF-IVA                                                           -->
        <!--    03 PASAPORTE                                                         -->
        <!--    04 DOCUMENTO OFICIAL DE IDENTIFICACIÓN EXPEDIDO POR EL PAIS O TERRITORIO DE RESIDENCIA -->
        <!--    05 CERTIFICADO DE RESIDENCIA                                         -->
        <!--    06 OTRO DOCUMENTO PROBATORIO                                         -->
        <!-- ======================================================================= -->
<!-- test fcmfcm
        <if>
            <expr>
                <isnotnull><contraparte_nif_spain/></isnotnull>
            </expr>
            <then>
                <set name='m_contraparte_nif'><xml.sii:NIF><contraparte_nif_spain/></xml.sii:NIF></set>
                <set name='m_contraparte_idotro'><string/></set>
            </then>
            <else>
                <set name='m_contraparte_nif'><string/></set>
                <set name='m_contraparte_idotro'>
                    <xml.sii:IDOtro>
                        <xml.sii:CodigoPais><contraparte_coda2/></xml.sii:CodigoPais>
                        <xml.sii:IDType><contraparte_idtype/></xml.sii:IDType>
                        <xml.sii:ID><contraparte_nif_contraparte/></xml.sii:ID>
                    </xml.sii:IDOtro>
                </set>
            </else>
        </if>
-->

        <!-- ======================================================================= -->
        <!-- sii:BaseImponibleACoste                                                 -->
        <!--     Para grupos de IVA                                                  -->
        <!-- ClaveRegimenEspecialOTrascendencia   (Emitidas y Recibidas)             -->
        <!--                                                                         -->
        <!-- L3 FE  06  Régimen especial grupo de entidades en IVA (Nivel Avanzado)  -->
        <!-- L3 FR  06  Régimen especial grupo de entidades en IVA (Nivel Avanzado)  -->
        <!-- ======================================================================= -->
        <set name='str_baseimponibleacoste'><string/></set>
        <if>
            <expr>
                <ne><m_baseimponibleacoste/>0</ne>
            </expr>
            <then>
                <set name='str_baseimponibleacoste'><xml.sii:BaseImponibleACoste><m_baseimponibleacoste/></xml.sii:BaseImponibleACoste></set>
            </then>
        </if>

        <!-- ======================================================================= -->
        <!-- DescripcionOperacion                                                    -->
        <!-- ======================================================================= -->
        <set name='str_desc_operacion'><string/></set>
        <if>
            <expr>
                <isnotnull><p_descoperacion/></isnotnull>
            </expr>
            <then>
                <set name='str_desc_operacion'>
                    <xml.sii:DescripcionOperacion><p_descoperacion/></xml.sii:DescripcionOperacion>
                </set>
            </then>
        </if>

        <!-- ======================================================================= -->
        <!-- Las facturas de ventas de alquileres sin retención deben informar la    -->
        <!-- situación y la referencia catastral de los inmuebles.                   -->
        <!--                                                                         -->
        <!-- DatosInmueble                                                           -->
        <!--    DetalleInmueble                                                      -->
        <!--        SituacionInmueble                                                -->
        <!--        ReferenciaCatastral                                              -->
        <!--                                                                         -->
        <!-- L6 Situación del Inmueble                                               -->
        <!--     1 Inmueble con referencia catastral situado en cualquier punto del territorio español, excepto País Vasco y Navarra  -->
        <!--     2 Inmueble situado en la Comunidad Autónoma del País Vasco o en la Comunidad Foral de Navarra                        -->
        <!--     3 Inmueble en cualquiera de las situaciones anteriores pero sin referencia catastral                                 -->
        <!--     4 Inmueble situado en el extranjero                                                                                  -->
        <!--                                                                         -->
        <!-- Código província:                                                       -->
        <!--     01  ALAVA                                                           -->
        <!--     20  GUIPUZCOA                                                       -->
        <!--     48  VIZCAYA                                                         -->
        <!--     31  NAVARRA                                                         -->
        <!--                                                                         -->
        <!-- L3 FE  11  Arrendamiento local de negocio sujetas a retención           -->
        <!-- L3 FE  12  Arrendamiento local de negocio no sujetas a retención        -->
        <!-- L3 FE  13  Arrendamiento de local de negocio sujetas y no sujetas a ret -->
        <!-- ======================================================================= -->
        <if>
            <expr>
                <or>
                    <eq><p_claveoperacion/><string>12</string></eq>
					<eq><p_claveoperacion/><string>13</string></eq>					
                    <eq><ifnull><p_claveoperaciona1/><string/></ifnull><string>12</string></eq>
                    <eq><ifnull><p_claveoperaciona2/><string/></ifnull><string>12</string></eq>
                </or>
            </expr>
            <then>
                <!-- ======================================================================= -->
                <!-- Si solo hay una referencia obtiene los datos directamwente.             -->
                <!-- ======================================================================= -->
                <if>
                    <expr>
                        <eq><string.length><str_datosinmueble/></string.length>0</eq>
                    </expr>
                    <then>

                        <set name='m_inm_situacion'><cimpcont_head_aux_inm_situacion/></set>
                        <set name='m_inm_refer_catastral'><cimpcont_head_aux_inm_refer_catastral/></set>

                        <!-- Situación inmueble -->
                        <if>
                            <expr>
                                <and>
                                    <isnull><m_inm_situacion/></isnull>
                                    <isnotnull><m_default_inm_situacion/></isnotnull>
                                </and>
                            </expr>
                            <then>
                                <set name='m_inm_situacion'><m_default_inm_situacion/></set>
                            </then>
                        </if>

                        <!-- Referencia catastral -->
                        <if>
                            <expr>
                                <and>
                                    <isnull><m_inm_refer_catastral/></isnull>
                                    <isnotnull><m_default_inm_refer_catastral/></isnotnull>
                                </and>
                            </expr>
                            <then>
                                <set name='m_inm_refer_catastral'><m_default_inm_refer_catastral/></set>
                            </then>
                        </if>

                        <!-- ======================================================================= -->
                        <!-- local_get_datosinmueble                                                 -->
                        <!-- ======================================================================= -->
                        <local_get_datosinmueble into='str_datosinmueble'>
                            <p_empcode/>
                            <m_inm_situacion/>
                            <m_inm_refer_catastral/>
                        </local_get_datosinmueble>

                        <!-- ======================================================================= -->
                        <!-- Comprueba la información del inmueble                                   -->
                        <!-- ======================================================================= -->
                        <if>
                            <expr>
                                <and>
                                    <!-- Si la operación principal es 06 grupo de sociedades (Nivel avanzado) no se exigen datos catastrales! -->
                                    <ne><p_claveoperacion/><string>06</string></ne>
                                    <eq><string.length><str_datosinmueble/></string.length>0</eq>
                                </and>
                            </expr>
                            <then>
                                <exception><string>Esta factura requiere la información del inmueble: situación y referencia catastral. Considere informar la referencia catastral en [cimpcont_head_aux.inm_refer_catastral] y en caso de grupo de referencias en la tabla: [es_sii_inm_refcat]. <string.nl/><m_msg_id_factura/></string></exception>
                            </then>
                        </if>

                    </then>
                </if>
            </then>
        </if>

        <!-- ======================================================================= -->
        <!-- EmitidaPorTerceros                                                      -->
        <!-- ======================================================================= -->
        <set name='m_emitidaporterceros'><string>N</string></set>
        <if>
            <expr>
                <eq><cimpcont_head_aux_fra_exp_tercero/>1</eq>
            </expr>
            <then>
                <set name='m_emitidaporterceros'><string>S</string></set>
            </then>
        </if>

        <!-- ======================================================================= -->
        <!-- ClaveRegimenEspecialOTrascendenciaAdicional1                            -->
        <!-- ======================================================================= -->
        <set name='str_claveregimenespecialotrascendenciaadicional1'><string/></set>
        <if>
            <expr>
                <isnotnull><p_claveoperaciona1/></isnotnull>
            </expr>
            <then>
                <set name='str_claveregimenespecialotrascendenciaadicional1'><xml.sii:ClaveRegimenEspecialOTrascendenciaAdicional1><p_claveoperaciona1/></xml.sii:ClaveRegimenEspecialOTrascendenciaAdicional1></set>
            </then>
        </if>

        <!-- ======================================================================= -->
        <!-- ClaveRegimenEspecialOTrascendenciaAdicional2                            -->
        <!-- ======================================================================= -->
        <set name='str_claveregimenespecialotrascendenciaadicional2'><string/></set>
        <if>
            <expr>
                <isnotnull><p_claveoperaciona2/></isnotnull>
            </expr>
            <then>
                <set name='str_claveregimenespecialotrascendenciaadicional2'><xml.sii:ClaveRegimenEspecialOTrascendenciaAdicional2><p_claveoperaciona2/></xml.sii:ClaveRegimenEspecialOTrascendenciaAdicional2></set>
            </then>
        </if>

        <!-- ======================================================================= -->
        <!-- Las facturas simplificadas no emiten la información de la contraparte.  -->
        <!--                                                                         -->
        <!--     F2 Factura simplificada (ticket)                                                 -->
        <!--     F4 Asiento resumen de facturas  ( Ssientos resumen de facturas simplificadas )   -->
        <!--     R5 Factura rectificativa en facturas simplificadas                               -->
        <!--                                                                         -->

        <!-- ======================================================================= -->
        <set name='str_contraparte'><string/></set>
        <if>
            <expr>
                <not><string.regexp><p_tipofactura/><string>(F2|F4|R5)</string></string.regexp></not>
            </expr>
            <then>
                <set name='str_contraparte'>
                    <xml.sii:Contraparte>
                        <xml.sii:NombreRazon><m_contraparte_nombrerazon/></xml.sii:NombreRazon>
                        <m_contraparte_nif/><m_contraparte_idotro/>
                    </xml.sii:Contraparte>
                </set>
            </then>
        </if>
        <!-- ======================================================================= -->
        <!-- siiLR:FacturaExpedida                                                   -->

        <!-- ======================================================================= -->
        <set name='str_facturaexpedida'>
            <xml.siiLR:FacturaExpedida>
            <xml.sii:TipoFactura><p_tipofactura/></xml.sii:TipoFactura>
            <str_tiporectificativa/>
            <str_facturasagrupadas/>
            <str_facturasrectificadas/>
            <str_fechaoperacion/>
            <xml.sii:ClaveRegimenEspecialOTrascendencia><p_claveoperacion/></xml.sii:ClaveRegimenEspecialOTrascendencia>
            <str_claveregimenespecialotrascendenciaadicional1/><str_claveregimenespecialotrascendenciaadicional2/>
            <xml.sii:ImporteTotal><p_importetotal/></xml.sii:ImporteTotal>
            <str_baseimponibleacoste/>
            <str_desc_operacion/>
            <str_datosinmueble/>
            <xml.sii:EmitidaPorTerceros><m_emitidaporterceros/></xml.sii:EmitidaPorTerceros>
            <str_contraparte/>
            <str_tipodesglose/>
            </xml.siiLR:FacturaExpedida>
        </set>
        <!-- ======================================================================= -->
        <!-- XML una factura                                                         -->
        <!-- ======================================================================= -->
        <set name='m_message_one_invoice'>
            <xml.siiLR:RegistroLRFacturasEmitidas>
                <str_periodoimpositivo/>
                <str_idfactura/>
                <str_facturaexpedida/>
            </xml.siiLR:RegistroLRFacturasEmitidas>
        </set>

        <!-- ======================================================================= -->
        <!--                                                                         -->
        <!-- ======================================================================= -->
        <return>
            <m_message_one_invoice/>
        </return>

    </body>
</xsql-script>